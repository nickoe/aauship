
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      --><title>kalman</title><meta name="generator" content="MATLAB 8.0"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2012-11-30"><meta name="DC.source" content="kalman.m"><style type="text/css">
html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,font,img,ins,kbd,q,s,samp,small,strike,strong,sub,sup,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}:focus{outine:0}ins{text-decoration:none}del{text-decoration:line-through}table{border-collapse:collapse;border-spacing:0}

html { min-height:100%; margin-bottom:1px; }
html body { height:100%; margin:0px; font-family:Arial, Helvetica, sans-serif; font-size:10px; color:#000; line-height:140%; background:#fff none; overflow-y:scroll; }
html body td { vertical-align:top; text-align:left; }

h1 { padding:0px; margin:0px 0px 25px; font-family:Arial, Helvetica, sans-serif; font-size:1.5em; color:#d55000; line-height:100%; font-weight:normal; }
h2 { padding:0px; margin:0px 0px 8px; font-family:Arial, Helvetica, sans-serif; font-size:1.2em; color:#000; font-weight:bold; line-height:140%; border-bottom:1px solid #d6d4d4; display:block; }
h3 { padding:0px; margin:0px 0px 5px; font-family:Arial, Helvetica, sans-serif; font-size:1.1em; color:#000; font-weight:bold; line-height:140%; }

a { color:#005fce; text-decoration:none; }
a:hover { color:#005fce; text-decoration:underline; }
a:visited { color:#004aa0; text-decoration:none; }

p { padding:0px; margin:0px 0px 20px; }
img { padding:0px; margin:0px 0px 20px; border:none; }
p img, pre img, tt img, li img { margin-bottom:0px; } 

ul { padding:0px; margin:0px 0px 20px 23px; list-style:square; }
ul li { padding:0px; margin:0px 0px 7px 0px; }
ul li ul { padding:5px 0px 0px; margin:0px 0px 7px 23px; }
ul li ol li { list-style:decimal; }
ol { padding:0px; margin:0px 0px 20px 0px; list-style:decimal; }
ol li { padding:0px; margin:0px 0px 7px 23px; list-style-type:decimal; }
ol li ol { padding:5px 0px 0px; margin:0px 0px 7px 0px; }
ol li ol li { list-style-type:lower-alpha; }
ol li ul { padding-top:7px; }
ol li ul li { list-style:square; }

.content { font-size:1.2em; line-height:140%; padding: 20px; }

pre, tt, code { font-size:12px; }
pre { margin:0px 0px 20px; }
pre.error { color:red; }
pre.codeinput { padding:10px; border:1px solid #d3d3d3; background:#f7f7f7; }
pre.codeoutput { padding:10px 11px; margin:0px 0px 20px; color:#4c4c4c; }

@media print { pre.codeinput, pre.codeoutput { word-wrap:break-word; width:100%; } }

span.keyword { color:#0000FF }
span.comment { color:#228B22 }
span.string { color:#A020F0 }
span.untermstring { color:#B20000 }
span.syscmd { color:#B28C00 }

.footer { width:auto; padding:10px 0px; margin:25px 0px 0px; border-top:1px dotted #878787; font-size:0.8em; line-height:140%; font-style:italic; color:#878787; text-align:left; float:none; }
.footer p { margin:0px; }
.footer a { color:#878787; }
.footer a:hover { color:#878787; text-decoration:underline; }
.footer a:visited { color:#878787; }

table th { padding:7px 5px; text-align:left; vertical-align:middle; border: 1px solid #d6d4d4; font-weight:bold; }
table td { padding:7px 5px; text-align:left; vertical-align:top; border:1px solid #d6d4d4; }





  </style></head><body><div class="content"><h2>Contents</h2><div><ul><li><a href="#1">Kalman Filter Implementation for AAUSHIP1:</a></li><li><a href="#2">Number of Samples:</a></li><li><a href="#3">System Parameters:</a></li><li><a href="#4">System Definition:</a></li><li><a href="#5">Noise Terms (Input and Measurement Noise):</a></li><li><a href="#6">Covariance Matrices:</a></li><li><a href="#7">System initiation:</a></li><li><a href="#8">Running Computation of the Monorate Kalman filter:</a></li><li><a href="#9">Output definitions:</a></li><li><a href="#10">Plot of figures for same Monorate sampling:</a></li><li><a href="#11">Running Computation of the Multirate Kalman filter (Negating the GPS input when no new sample is present):</a></li><li><a href="#12">Output definitions - Multirate sampling:</a></li><li><a href="#13">Plot - Multirate Sampling (x,y,w)</a></li><li><a href="#14">Running Computation of the Multirate Kalman filter (Using previous GPS input when no new sample is present):</a></li><li><a href="#15">Output definintions - Multirate (Only changing at the new update steps!).</a></li><li><a href="#16">Plot - Multirate Sampling (Using same samplings input as last time).</a></li><li><a href="#17">Calculation differente between Monorate and Multirate</a></li><li><a href="#18">Plot of the error between monorate and multirate:</a></li><li><a href="#19">Estiamting a Wind Bias:</a></li><li><a href="#20">Combined Kalman filter with test inputs:</a></li></ul></div><h2>Kalman Filter Implementation for AAUSHIP1:<a name="1"></a></h2><p>Rasmus Christensen 26/11/2012 - 12gr730 - AAUSHIP Kalaman Filter (c)</p><pre class="codeinput">clc; clear <span class="string">all</span>; close <span class="string">all</span>;
<span class="comment">% for lunde = 1:15</span>
<span class="comment">%     clf(lunde)</span>
<span class="comment">% end</span>
run(<span class="string">'contsimu.m'</span>);
load <span class="string">inputD.mat</span>; <span class="comment">% Loads system input file from contsimu.m</span>
inputD = inputD';
close <span class="string">all</span>;

<span class="comment">% To reduce the amount of noise on the measurements which are fed to the</span>
<span class="comment">% system, and to enhance the precision of these, the data is run through a</span>
<span class="comment">% Kalman filter which is then estiamtes the position, given the noisy</span>
<span class="comment">% inputs. The HLI interface, which computes if the waypoint is reached,</span>
<span class="comment">% needs the X and Y position for the vessel to verify wether the ship has</span>
<span class="comment">% reached the desired waypoints. These two, can be measured by several</span>
<span class="comment">% devices, first of, the GPS spits out the position of the vessel, as well</span>
<span class="comment">% as the velocity. The velocity can be converted to a Y position, using the</span>
<span class="comment">% inverse of the rotation matrix. Using the IMU on board the ship, we're</span>
<span class="comment">% able to measure the acceleration in the X and Y direction. The IMU also</span>
<span class="comment">% meausres the rotational acceleration around the center of the ship.</span>
<span class="comment">%</span>
<span class="comment">% Later, this can also be used to estimate the roll of the ship, to give</span>
<span class="comment">% the precise position of the measurement taken, using simple geometry!</span>
<span class="comment">%</span>
<span class="comment">% First of, the state vector Y is defined as:</span>
<span class="comment">% Y(n) = A(n) * Y(n-1) + Z(n), where W(n) is driving noise/input to the</span>
<span class="comment">% system.</span>
<span class="comment">%</span>
<span class="comment">% Then the measuremen vector X can be defined as:</span>
<span class="comment">% X(n) = H(n) * Y(n) + W(n), where Z(n) expresses the noisy measurements.</span>
<span class="comment">%</span>
<span class="comment">% The desired measurements can be described as (the definition of the A</span>
<span class="comment">% matrix):</span>
</pre><pre class="codeoutput">
poles =

   -0.4462
         0
   -0.0784


disc_poles =

    0.9564
    1.0000
    0.9922

Warning: The file containing block diagram 'contsim' has been changed on disk
since it was loaded.  You should close it, and Simulink will reload it if
necessary. 
Warning: The "random" waveform selection of 'contsim/Signal Generator' is
provided for backwards compatibility. It will be removed in a future version and
should be replaced with the appropriate random number generator 
Warning: Using a default value of 20.0 for maximum step size.  The simulation
step size will be equal to or less than this value.  You can disable this
diagnostic by setting 'Automatic solver parameter selection' diagnostic to
'none' in the Diagnostics page of the configuration parameters dialog 
Warning: The file containing block diagram 'contsim' has been changed on disk
since it was loaded.  You should close it, and Simulink will reload it if
necessary. 
Warning: Output port 1 of 'discsim/Add' is not connected. 
Warning: Output port 1 of 'discsim/Band-Limited White Noise' is not connected. 
Warning: Input port 1 of 'discsim/Smoothing Process' is not connected. 
Warning: Output port 1 of 'discsim/Smoothing Process' is not connected. 
Warning: The model 'discsim' does not have continuous states, hence Simulink is
using the solver 'FixedStepDiscrete' instead of solver 'ode3'. You can disable
this diagnostic by explicitly specifying a discrete solver in the solver tab of
the Configuration Parameters dialog, or by setting the 'Automatic solver
parameter selection' diagnostic to 'none' in the Diagnostics tab of the
Configuration Parameters dialog 
</pre><h2>Number of Samples:<a name="2"></a></h2><pre class="codeinput">ts = 0.05; <span class="comment">% Sampling time</span>
N = 1000; <span class="comment">% Then it fits with the Simulink Simulation!</span>
</pre><h2>System Parameters:<a name="3"></a></h2><pre class="codeinput">m = 12; <span class="comment">% The ships mass</span>
I = (1/12)*m*(0.25*0.25+1.05*1.05); <span class="comment">% The ships inertia</span>

betaX = 0.4462;
betaY = 0.8;
betaW = 0.0784;
GPS_freq = 20;
</pre><h2>System Definition:<a name="4"></a></h2><pre class="codeinput">Hn = [1 ts (ts^2)/2 0 0 0 0 0 0;<span class="keyword">...</span><span class="comment"> % The X position</span>
      0 1 ts 0 0 0 0 0 0;<span class="keyword">...</span><span class="comment"> % The X velocity</span>
      0 -betaX 0 0 0 0 0 0 0;<span class="keyword">...</span><span class="comment"> % The X acceleration is a sum of forward motion (F_forward - F_drag)</span>
      0 0 0 1 ts (ts^2)/2 0 0 0;<span class="keyword">...</span><span class="comment"> % The Y Position</span>
      0 0 0 0 1 ts 0 0 0;<span class="keyword">...</span><span class="comment"> % The Y Velocity</span>
      0 0 0 0 -betaY 0 0 0 0;<span class="keyword">...</span><span class="comment"> % The Y acceleration is a sum of the sideways motion (F_ymotion (wind?) - F_dragY)</span>
      0 0 0 0 0 0 1 ts (ts^2)/2;<span class="keyword">...</span><span class="comment"> % The angle</span>
      0 0 0 0 0 0 0 1 ts;<span class="keyword">...</span><span class="comment"> % The angular velocity</span>
      0 0 0 0 0 0 0 -betaW 0]; <span class="comment">% The angular acceleration is a sum of the drag an induced torque!</span>

An = eye(9); <span class="comment">% An eye matrix, as all the outputs scales equally - everything is in metric units!</span>
</pre><h2>Noise Terms (Input and Measurement Noise):<a name="5"></a></h2><p>The Z(n) is the "driving noise" - as the system input is a forward force and a torque, these are input here as well. The "input" matrix for the driving noise Z(n) is then equal to:</p><pre class="codeinput">Bn = [0 0;<span class="keyword">...</span>
     0 0;<span class="keyword">...</span>
     1/m 0;<span class="keyword">...</span><span class="comment"> % From force to input acceleration</span>
     0 0;<span class="keyword">...</span>
     0 0;<span class="keyword">...</span>
     0 0;<span class="keyword">...</span>
     0 0;<span class="keyword">...</span>
     0 0;<span class="keyword">...</span>
     0 1/I]; <span class="comment">% From torque to angular acceleration</span>

 <span class="keyword">for</span> ii = 1:N
    Z(:,ii) = Bn*inputD(:,ii);
<span class="keyword">end</span>

<span class="comment">% W is the measurement noise on the system, this can be estimated to be</span>
<span class="comment">% white gaussian noise, with zero mean (for most cases) and with a</span>
<span class="comment">% variance, that are estimated in Appendix #XX.</span>
varXpos = 0.979;
varXvel = 0.00262;
varXacc = 4.9451e-5; <span class="comment">%  m/s^2 or 5.045*10^-6 G</span>

varYpos = 1.12;
varYvel = 0.0001;
varYacc = 4.8815e-5; <span class="comment">% m/s^2; or 4.9801*10^-6 G</span>

varWpos = 0.2;
varWvel = 0.0001;
varWacc = 2.3559e-5; <span class="comment">% m/s^2 or 2.4035*10^-6 G</span>

varYWacc = 2.4496*10^-6; <span class="comment">% rad/s^2</span>
SqM = sqrt([varXpos varXvel varXacc varYpos varYvel varYacc varWpos varWvel varWacc]);

 <span class="comment">% Random number at each iteration with a given variance.</span>
</pre><h2>Covariance Matrices:<a name="6"></a></h2><p>As the vector Kalman filter have several system inputs, the noise added to the system generates a covariance matrix. These are computed below. The covariance of a vector is given as: cov(Z_i(n),Z_j(n)) = E[(Zi-mu_i)(Zj - mu_j)]. If the process is zero mean, this becomes a matrix with the diagonal entires given as: cov(Z(n) = E[Z(n)*Z(n)'], but as the inputs to the system, cannot be considered to be zero mean, the latter is not used. Qz = cov(Z(n-1)*Z(n)'); The measuremnets, are considered to be white gaussian zero mean noise, and this can then be considered to be a diagonal matrix with the elements squared, hence there is no need for the square root, as this just gives the variance it self.</p><h2>System initiation:<a name="7"></a></h2><p>The system is initialized, the parameters are:</p><pre class="codeinput">Wn = zeros(9,N);
Qz = zeros(9,9,N);
Qw = zeros(9,9,N);
Y = zeros(9,N);
X = zeros(9,N);
Ypred = zeros(9,N);
Xpred = zeros(9,N);
Rpred = zeros(9,9,N);
B = zeros(9,9,N);
Yupdate = zeros(9,N);
Rupdate = zeros(9,9,N);
k_newpos = zeros(2,N);
y_newpos = zeros(2,N);
x_newpos = zeros(2,N);
k_rot = zeros(2,2,N);
y_rot = zeros(2,2,N);
x_rot = zeros(2,2,N);
</pre><h2>Running Computation of the Monorate Kalman filter:<a name="8"></a></h2><pre class="codeinput"><span class="keyword">for</span> n = 2:N;
       Wn(:,n) = randn(9,1).*SqM';
     Qz(:,:,n) = cov(Z(:,n-1)*Z(:,n)');
     Qw(:,:,n) = diag([varXpos varXvel varXacc varYpos varYvel varYacc varWpos varWvel varWacc]);
        Y(:,n) = Hn*Y(:,n-1)+Z(:,n);
        X(:,n) = An*Y(:,n)+Wn(:,n);
    Ypred(:,n) = Hn*Yupdate(:,n-1);
    Xpred(:,n) = An*Ypred(:,n);
  Rpred(:,:,n) = Hn*Rupdate(:,:,n-1)*Hn'+Qz(:,:,n);
      B(:,:,n) = (Rpred(:,:,n)*An')/(An*Rpred(:,:,n)*An'+Qw(:,:,n));
  Yupdate(:,n) = Ypred(:,n)+B(:,:,n)*(X(:,n)-Xpred(:,n));
Rupdate(:,:,n) = (eye(9)-B(:,:,n)*An)*Rpred(:,:,n);
<span class="comment">% Below - rotation udpate, so the route can be plotted:</span>
  k_rot(:,:,n) = [cos(Yupdate(7,n-1)) -sin(Yupdate(7,n-1));sin(Yupdate(7,n-1)) cos(Yupdate(7,n-1))];
 k_newpos(:,n) = k_newpos(:,n-1) + k_rot(:,:,n)*[Yupdate(2,n-1);Yupdate(5,n-1)].*ts; <span class="comment">% k_newposD(:,n-1)</span>
  y_rot(:,:,n) = [cos(Y(7,n-1)) -sin(Y(7,n-1));sin(Y(7,n-1)) cos(Y(7,n-1))];
 y_newpos(:,n) = y_newpos(:,n-1) + y_rot(:,:,n)*[Y(2,n-1);Y(5,n-1)].*ts;
  x_rot(:,:,n) = [cos(X(7,n-1)) -sin(X(7,n-1));sin(X(7,n-1)) cos(X(7,n-1))];
 x_newpos(:,n) = y_newpos(:,n-1) + x_rot(:,:,n)*[X(2,n-1);X(5,n-1)].*ts;
<span class="keyword">end</span>
</pre><h2>Output definitions:<a name="9"></a></h2><p>Filtered:</p><pre class="codeinput">Y_kal_pos_X = Yupdate(1,:)'; <span class="comment">% Updated Y - x position</span>
Y_kal_vel_X = Yupdate(2,:)';
Y_kal_acc_X = Yupdate(3,:)';

Y_kal_pos_Y = Yupdate(4,:)'; <span class="comment">% Updated Y - y position</span>
Y_kal_vel_Y = Yupdate(5,:)';
Y_kal_acc_Y = Yupdate(6,:)';

Y_kal_pos_W = Yupdate(7,:)'; <span class="comment">% Updated Y - angle</span>
Y_kal_vel_W = Yupdate(8,:)';
Y_kal_acc_W = Yupdate(9,:)';

<span class="comment">% Measured:</span>
X_pos_X = X(1,:)'; <span class="comment">% Observation X - x position</span>
X_vel_X = X(2,:)';
X_acc_X = X(3,:)';

X_pos_Y = X(4,:)'; <span class="comment">% Observation X - y position</span>
X_vel_Y = X(5,:)';
X_acc_Y = X(6,:)';

X_pos_W = X(7,:)'; <span class="comment">% Observation X - angle</span>
X_vel_W = X(8,:)';
X_acc_W = X(9,:)';

<span class="comment">% Actual:</span>
Y_pos_X = Y(1,:)'; <span class="comment">% True Y - x position</span>
Y_vel_X = Y(2,:)';
Y_acc_X = Y(3,:)';

Y_pos_Y = Y(4,:)'; <span class="comment">% True Y - x position</span>
Y_vel_Y = Y(5,:)';
Y_acc_Y = Y(6,:)';

Y_pos_W = Y(7,:)'; <span class="comment">% True Y - x position</span>
Y_vel_W = Y(8,:)';
Y_acc_W = Y(9,:)';
</pre><h2>Plot of figures for same Monorate sampling:<a name="10"></a></h2><p>Plot of position (x,y,w)</p><pre class="codeinput">h1 = figure(1);
subplot(3,1,1)
hold <span class="string">on</span>
plot(X_pos_X,<span class="string">'g+'</span>,<span class="string">'MarkerSize'</span>,2);
plot(Y_kal_pos_X,<span class="string">'b'</span>,<span class="string">'LineWidth'</span>,1);
plot(Y_pos_X,<span class="string">'m'</span>,<span class="string">'LineWidth'</span>,1);
hold <span class="string">off</span>
title(<span class="string">'X-Position Estimation - Monorate'</span>)
legend(<span class="string">'Measured'</span>,<span class="string">'Filtered'</span>,<span class="string">'True'</span>)
xlabel(<span class="string">'Sample [n]'</span>) ;ylabel(<span class="string">'Position [m]'</span>);
grid <span class="string">on</span>

subplot(3,1,2)
hold <span class="string">on</span>
plot(X_pos_Y,<span class="string">'g+'</span>,<span class="string">'MarkerSize'</span>,2);
plot(Y_kal_pos_Y,<span class="string">'b'</span>,<span class="string">'LineWidth'</span>,1);
plot(Y_pos_Y,<span class="string">'m'</span>,<span class="string">'LineWidth'</span>,1);
hold <span class="string">off</span>
title(<span class="string">'Y-Position Estimation - Monorate'</span>)
legend(<span class="string">'Measured'</span>,<span class="string">'Filtered'</span>,<span class="string">'True'</span>)
xlabel(<span class="string">'Sample [n]'</span>) ;ylabel(<span class="string">'Position [m]'</span>);
grid <span class="string">on</span>

subplot(3,1,3)
hold <span class="string">on</span>
plot(X_pos_W,<span class="string">'g+'</span>,<span class="string">'MarkerSize'</span>,2);
plot(Y_kal_pos_W,<span class="string">'b'</span>,<span class="string">'LineWidth'</span>,1);
plot(Y_pos_W,<span class="string">'m'</span>,<span class="string">'LineWidth'</span>,1);
hold <span class="string">off</span>
title(<span class="string">'Angle Estimation - Monorate'</span>)
legend(<span class="string">'Measured'</span>,<span class="string">'Filtered'</span>,<span class="string">'True'</span>)
xlabel(<span class="string">'Sample [n]'</span>) ;ylabel(<span class="string">'Angle [rad]'</span>);
grid <span class="string">on</span>

<span class="comment">% Plot of velocity (x,y,w)</span>
h2 = figure(2);
subplot(3,1,1)
hold <span class="string">on</span>
plot(X_vel_X,<span class="string">'g+'</span>,<span class="string">'MarkerSize'</span>,2);
plot(Y_kal_vel_X,<span class="string">'b'</span>,<span class="string">'LineWidth'</span>,1);
plot(Y_vel_X,<span class="string">'m'</span>,<span class="string">'LineWidth'</span>,1);
hold <span class="string">off</span>
title(<span class="string">'X-Velocity Estimation'</span>)
legend(<span class="string">'Measured'</span>,<span class="string">'Filtered'</span>,<span class="string">'True'</span>)
xlabel(<span class="string">'Sample [n]'</span>) ;ylabel(<span class="string">'Velocity [m/s]'</span>);
grid <span class="string">on</span>

subplot(3,1,2)
hold <span class="string">on</span>
plot(X_vel_Y,<span class="string">'g+'</span>,<span class="string">'MarkerSize'</span>,2);
plot(Y_kal_vel_Y,<span class="string">'b'</span>,<span class="string">'LineWidth'</span>,1);
plot(Y_vel_Y,<span class="string">'m'</span>,<span class="string">'LineWidth'</span>,1);
hold <span class="string">off</span>
title(<span class="string">'Y-Velocity Estimation'</span>)
legend(<span class="string">'Measured'</span>,<span class="string">'Filtered'</span>,<span class="string">'True'</span>)
xlabel(<span class="string">'Sample [n]'</span>) ;ylabel(<span class="string">'Velocity [m/s]'</span>);
grid <span class="string">on</span>

subplot(3,1,3)
hold <span class="string">on</span>
plot(X_vel_W,<span class="string">'g+'</span>,<span class="string">'MarkerSize'</span>,2);
plot(Y_kal_vel_W,<span class="string">'b'</span>,<span class="string">'LineWidth'</span>,1);
plot(Y_vel_W,<span class="string">'m'</span>,<span class="string">'LineWidth'</span>,1);
hold <span class="string">off</span>
title(<span class="string">'Angular Velocity Estimation'</span>)
legend(<span class="string">'Measured'</span>,<span class="string">'Filtered'</span>,<span class="string">'True'</span>)
xlabel(<span class="string">'Sample [n]'</span>) ;ylabel(<span class="string">'Angular velocity [rad/s]'</span>);
grid <span class="string">on</span>

<span class="comment">% Plot of acceleration (x,y,w)</span>
h3 = figure(3);
subplot(3,1,1)
hold <span class="string">on</span>
plot(X_acc_X,<span class="string">'g+'</span>,<span class="string">'MarkerSize'</span>,2);
plot(Y_kal_acc_X,<span class="string">'b'</span>,<span class="string">'LineWidth'</span>,1);
plot(Y_acc_X,<span class="string">'m'</span>,<span class="string">'LineWidth'</span>,1);
hold <span class="string">off</span>
title(<span class="string">'X-Acceleration Estimation'</span>)
legend(<span class="string">'Measured'</span>,<span class="string">'Filtered'</span>,<span class="string">'True'</span>)
xlabel(<span class="string">'Sample [n]'</span>) ;ylabel(<span class="string">'Acceleration [m/s^2]'</span>);
grid <span class="string">on</span>

subplot(3,1,2)
hold <span class="string">on</span>
plot(X_acc_Y,<span class="string">'g+'</span>,<span class="string">'MarkerSize'</span>,2);
plot(Y_kal_acc_Y,<span class="string">'b'</span>,<span class="string">'LineWidth'</span>,1);
plot(Y_acc_Y,<span class="string">'m'</span>,<span class="string">'LineWidth'</span>,1);
hold <span class="string">off</span>
title(<span class="string">'Y-Acceleration Estimation'</span>)
legend(<span class="string">'Measured'</span>,<span class="string">'Filtered'</span>,<span class="string">'True'</span>)
xlabel(<span class="string">'Sample [n]'</span>) ;ylabel(<span class="string">'Acceleration [m/s^2]'</span>);
grid <span class="string">on</span>

subplot(3,1,3)
hold <span class="string">on</span>
plot(X_acc_W,<span class="string">'g+'</span>,<span class="string">'MarkerSize'</span>,2);
plot(Y_kal_acc_W,<span class="string">'b'</span>,<span class="string">'LineWidth'</span>,1);
plot(Y_acc_W,<span class="string">'m'</span>,<span class="string">'LineWidth'</span>,1);
hold <span class="string">off</span>
title(<span class="string">'Angular Acceleration Estimation'</span>)
legend(<span class="string">'Measured'</span>,<span class="string">'Filtered'</span>,<span class="string">'True'</span>)
xlabel(<span class="string">'Sample [n]'</span>) ;ylabel(<span class="string">'Angular acceleration [rad/s]'</span>);
grid <span class="string">on</span>

<span class="comment">% Plot of actual X-Y position</span>
h4 = figure(4);
hold <span class="string">on</span>
plot(x_newpos(1,:),x_newpos(2,:),<span class="string">'g+'</span>,<span class="string">'MarkerSize'</span>,2);
plot(k_newpos(1,:),k_newpos(2,:),<span class="string">'b'</span>,<span class="string">'LineWidth'</span>,1);
plot(y_newpos(1,:),y_newpos(2,:),<span class="string">'m'</span>,<span class="string">'LineWidth'</span>,1);
hold <span class="string">off</span>
title(<span class="string">'XY Position - Monorate'</span>)
legend(<span class="string">'Measured'</span>,<span class="string">'Filtered'</span>,<span class="string">'True'</span>)
xlabel(<span class="string">'Position [m]'</span>)
ylabel(<span class="string">'Position [m]'</span>)
grid <span class="string">on</span>
</pre><img vspace="5" hspace="5" src="kalman_01.png" alt=""> <img vspace="5" hspace="5" src="kalman_02.png" alt=""> <img vspace="5" hspace="5" src="kalman_03.png" alt=""> <img vspace="5" hspace="5" src="kalman_04.png" alt=""> <h2>Running Computation of the Multirate Kalman filter (Negating the GPS input when no new sample is present):<a name="11"></a></h2><p>As not all of the measurements are sampled at the same time (some are slower, as the GPS for instance) - the samples where no GPS reading is available will have to increase the level of the noise. Below is a list of the sampling speeds of the sensors mounted on the ship: GPS = 1Hz; IMU = 20Hz; This calls for attention to the GPS measurements, as these are not sampled as often as the IMU! When this is done, the computation of the Kalman filter becomes:</p><pre class="codeinput"><span class="comment">% Resetting the parameters:</span>
YD = zeros(9,N);
XD = zeros(9,N);
YpredD = zeros(9,N);
XpredD = zeros(9,N);
RpredD = zeros(9,9,N);
BD = zeros(9,9,N);
YupdateD = zeros(9,N);
RupdateD = zeros(9,9,N);
k_newposD = zeros(2,N);
y_newposD = zeros(2,N);
x_newposD = zeros(2,N);
k_rotD = zeros(2,2,N);
y_rotD = zeros(2,2,N);
x_rotD = zeros(2,2,N);

sC = 0; <span class="comment">% Sample counter - used to only include the 10th GPS sample.</span>

<span class="keyword">for</span> n = 2:N;
            <span class="comment">%sC = isinteger(n/10) % Sensor Count, used to zero out unsampled system inputs.</span>
      <span class="comment">% Wn(:,n) = randn(9,1).*SqM';</span>
     Qz(:,:,n) = cov(Z(:,n-1)*Z(:,n)');
     Qw(:,:,n) = diag([varXpos varXvel varXacc varYpos varYvel varYacc varWpos varWvel varWacc]);
       YD(:,n) = Hn*YD(:,n-1)+Z(:,n);
       XD(:,n) = An*YD(:,n)+Wn(:,n);
   YpredD(:,n) = Hn*YupdateD(:,n-1);
   XpredD(:,n) = An*YpredD(:,n);
 RpredD(:,:,n) = Hn*RupdateD(:,:,n-1)*Hn'+Qz(:,:,n);
     BD(:,:,n) = (RpredD(:,:,n)*An')/(An*RpredD(:,:,n)*An'+Qw(:,:,n));
             <span class="keyword">if</span> sC == GPS_freq;
                   BD(:,:,n) = BD(:,:,n);
                          sC = 0;
             <span class="keyword">else</span>
                   BD(1,:,n) = zeros(1,9);
                   BD(4,:,n) = zeros(1,9);
             <span class="keyword">end</span>
 YupdateD(:,n) = YpredD(:,n)+BD(:,:,n)*(XD(:,n)-XpredD(:,n));
RupdateD(:,:,n) = (eye(9)-BD(:,:,n)*An)*RpredD(:,:,n);
            sC = sC + 1;
<span class="comment">% Below - rotation udpate, so the route can be plotted:</span>
  k_rotD(:,:,n) = [cos(YupdateD(7,n-1)) -sin(YupdateD(7,n-1));sin(YupdateD(7,n-1)) cos(YupdateD(7,n-1))];
 k_newposD(:,n) = k_newposD(:,n-1) + k_rotD(:,:,n)*[YupdateD(2,n-1);YupdateD(5,n-1)].*ts; <span class="comment">% k_newposD(:,n-1)</span>
  y_rotD(:,:,n) = [cos(YD(7,n-1)) -sin(YD(7,n-1));sin(YD(7,n-1)) cos(YD(7,n-1))];
 y_newposD(:,n) = y_newposD(:,n-1) + y_rotD(:,:,n)*[YD(2,n-1);YD(5,n-1)].*ts;
  x_rotD(:,:,n) = [cos(XD(7,n-1)) -sin(XD(7,n-1));sin(XD(7,n-1)) cos(XD(7,n-1))];
 x_newposD(:,n) = y_newposD(:,n-1) + x_rotD(:,:,n)*[XD(2,n-1);XD(5,n-1)].*ts;
<span class="keyword">end</span>
</pre><h2>Output definitions - Multirate sampling:<a name="12"></a></h2><p>Filtered:</p><pre class="codeinput">Y_kal_pos_XD = YupdateD(1,:)'; <span class="comment">% Updated Y - x position</span>
Y_kal_vel_XD = YupdateD(2,:)';
Y_kal_acc_XD = YupdateD(3,:)';

Y_kal_pos_YD = YupdateD(4,:)'; <span class="comment">% Updated Y - y position</span>
Y_kal_vel_YD = YupdateD(5,:)';
Y_kal_acc_YD = YupdateD(6,:)';

Y_kal_pos_WD = YupdateD(7,:)'; <span class="comment">% Updated Y - angle</span>
Y_kal_vel_WD = YupdateD(8,:)';
Y_kal_acc_WD = YupdateD(9,:)';

<span class="comment">% Measured:</span>
X_pos_XD = XD(1,:)'; <span class="comment">% Observation X - x position</span>
X_vel_XD = XD(2,:)';
X_acc_XD = XD(3,:)';

X_pos_YD = XD(4,:)'; <span class="comment">% Observation X - y position</span>
X_vel_YD = XD(5,:)';
X_acc_YD = XD(6,:)';

X_pos_WD = XD(7,:)'; <span class="comment">% Observation X - angle</span>
X_vel_WD = XD(8,:)';
X_acc_WD = XD(9,:)';

<span class="comment">% Actual:</span>
Y_pos_XD = YD(1,:)'; <span class="comment">% True Y - x position</span>
Y_vel_XD = YD(2,:)';
Y_acc_XD = YD(3,:)';

Y_pos_YD = YD(4,:)'; <span class="comment">% True Y - x position</span>
Y_vel_YD = YD(5,:)';
Y_acc_YD = YD(6,:)';

Y_pos_WD = YD(7,:)'; <span class="comment">% True Y - x position</span>
Y_vel_WD = YD(8,:)';
Y_acc_WD = YD(9,:)';
</pre><h2>Plot - Multirate Sampling (x,y,w)<a name="13"></a></h2><pre class="codeinput">h5 = figure(5);
subplot(3,1,1)
hold <span class="string">on</span>
plot(X_pos_XD,<span class="string">'g+'</span>,<span class="string">'MarkerSize'</span>,2);
plot(Y_kal_pos_XD,<span class="string">'b'</span>,<span class="string">'LineWidth'</span>,1);
plot(Y_pos_XD,<span class="string">'m'</span>,<span class="string">'LineWidth'</span>,1);
hold <span class="string">off</span>
title(<span class="string">'X-Position Estimation - Multirate'</span>)
legend(<span class="string">'Measured'</span>,<span class="string">'Filtered'</span>,<span class="string">'True'</span>)
xlabel(<span class="string">'Sample [n]'</span>) ;ylabel(<span class="string">'Position [m]'</span>);
grid <span class="string">on</span>

subplot(3,1,2)
hold <span class="string">on</span>
plot(X_pos_YD,<span class="string">'g+'</span>,<span class="string">'MarkerSize'</span>,2);
plot(Y_kal_pos_YD,<span class="string">'b'</span>,<span class="string">'LineWidth'</span>,1);
plot(Y_pos_YD,<span class="string">'m'</span>,<span class="string">'LineWidth'</span>,1);
hold <span class="string">off</span>
title(<span class="string">'Y-Position Estimation - Multirate'</span>)
legend(<span class="string">'Measured'</span>,<span class="string">'Filtered'</span>,<span class="string">'True'</span>)
xlabel(<span class="string">'Sample [n]'</span>) ;ylabel(<span class="string">'Position [m]'</span>);
grid <span class="string">on</span>

subplot(3,1,3)
hold <span class="string">on</span>
plot(X_pos_WD,<span class="string">'g+'</span>,<span class="string">'MarkerSize'</span>,2);
plot(Y_kal_pos_WD,<span class="string">'b'</span>,<span class="string">'LineWidth'</span>,1);
plot(Y_pos_WD,<span class="string">'m'</span>,<span class="string">'LineWidth'</span>,1);
hold <span class="string">off</span>
title(<span class="string">'Angle Estimation - Multirate'</span>)
legend(<span class="string">'Measured'</span>,<span class="string">'Filtered'</span>,<span class="string">'True'</span>)
xlabel(<span class="string">'Sample [n]'</span>) ;ylabel(<span class="string">'Angle [rad]'</span>);
grid <span class="string">on</span>

<span class="comment">% Plot of velocity (x,y,w)</span>
h6 = figure(6);
subplot(3,1,1)
hold <span class="string">on</span>
plot(X_vel_XD,<span class="string">'g+'</span>,<span class="string">'MarkerSize'</span>,2);
plot(Y_kal_vel_XD,<span class="string">'b'</span>,<span class="string">'LineWidth'</span>,1);
plot(Y_vel_XD,<span class="string">'m'</span>,<span class="string">'LineWidth'</span>,1);
hold <span class="string">off</span>
title(<span class="string">'X-Velocity Estimation - Multirate'</span>)
legend(<span class="string">'Measured'</span>,<span class="string">'Filtered'</span>,<span class="string">'True'</span>)
xlabel(<span class="string">'Sample [n]'</span>) ;ylabel(<span class="string">'Velocity [m/s]'</span>);
grid <span class="string">on</span>

subplot(3,1,2)
hold <span class="string">on</span>
plot(X_vel_YD,<span class="string">'g+'</span>,<span class="string">'MarkerSize'</span>,2);
plot(Y_kal_vel_YD,<span class="string">'b'</span>,<span class="string">'LineWidth'</span>,1);
plot(Y_vel_YD,<span class="string">'m'</span>,<span class="string">'LineWidth'</span>,1);
hold <span class="string">off</span>
title(<span class="string">'Y-Velocity Estimation - Multirate'</span>)
legend(<span class="string">'Measured'</span>,<span class="string">'Filtered'</span>,<span class="string">'True'</span>)
xlabel(<span class="string">'Sample [n]'</span>) ;ylabel(<span class="string">'Velocity [m/s]'</span>);
grid <span class="string">on</span>

subplot(3,1,3)
hold <span class="string">on</span>
plot(X_vel_WD,<span class="string">'g+'</span>,<span class="string">'MarkerSize'</span>,2);
plot(Y_kal_vel_WD,<span class="string">'b'</span>,<span class="string">'LineWidth'</span>,1);
plot(Y_vel_WD,<span class="string">'m'</span>,<span class="string">'LineWidth'</span>,1);
hold <span class="string">off</span>
title(<span class="string">'Angular Velocity Estimation - Multirate'</span>)
legend(<span class="string">'Measured'</span>,<span class="string">'Filtered'</span>,<span class="string">'True'</span>)
xlabel(<span class="string">'Sample [n]'</span>) ;ylabel(<span class="string">'Angular velocity [rad/s]'</span>);
grid <span class="string">on</span>

<span class="comment">% Plot of acceleration (x,y,w)</span>
h7 = figure(7);
subplot(3,1,1)
hold <span class="string">on</span>
plot(X_acc_XD,<span class="string">'g+'</span>,<span class="string">'MarkerSize'</span>,2);
plot(Y_kal_acc_XD,<span class="string">'b'</span>,<span class="string">'LineWidth'</span>,1);
plot(Y_acc_XD,<span class="string">'m'</span>,<span class="string">'LineWidth'</span>,1);
hold <span class="string">off</span>
title(<span class="string">'X-Acceleration Estimation - Multirate'</span>)
legend(<span class="string">'Measured'</span>,<span class="string">'Filtered'</span>,<span class="string">'True'</span>)
xlabel(<span class="string">'Sample [n]'</span>) ;ylabel(<span class="string">'Acceleration [m/s^2]'</span>);
grid <span class="string">on</span>

subplot(3,1,2)
hold <span class="string">on</span>
plot(X_acc_YD,<span class="string">'g+'</span>,<span class="string">'MarkerSize'</span>,2);
plot(Y_kal_acc_YD,<span class="string">'b'</span>,<span class="string">'LineWidth'</span>,1);
plot(Y_acc_YD,<span class="string">'m'</span>,<span class="string">'LineWidth'</span>,1);
hold <span class="string">off</span>
title(<span class="string">'Y-Acceleration Estimation - Multirate'</span>)
legend(<span class="string">'Measured'</span>,<span class="string">'Filtered'</span>,<span class="string">'True'</span>)
xlabel(<span class="string">'Sample [n]'</span>) ;ylabel(<span class="string">'Acceleration [m/s^2]'</span>);
grid <span class="string">on</span>

subplot(3,1,3)
hold <span class="string">on</span>
plot(X_acc_WD,<span class="string">'g+'</span>,<span class="string">'MarkerSize'</span>,2);
plot(Y_kal_acc_WD,<span class="string">'b'</span>,<span class="string">'LineWidth'</span>,1);
plot(Y_acc_WD,<span class="string">'m'</span>,<span class="string">'LineWidth'</span>,1);
hold <span class="string">off</span>
title(<span class="string">'Angular Acceleration Estimation - Multirate'</span>)
legend(<span class="string">'Measured'</span>,<span class="string">'Filtered'</span>,<span class="string">'True'</span>)
xlabel(<span class="string">'Sample [n]'</span>) ;ylabel(<span class="string">'Angular acceleration [rad/s]'</span>);
grid <span class="string">on</span>

<span class="comment">% Plot of actual X-Y position</span>
h8 = figure(8);
hold <span class="string">on</span>
plot(x_newposD(1,:),x_newposD(2,:),<span class="string">'g+'</span>,<span class="string">'MarkerSize'</span>,2);
plot(k_newposD(1,:),k_newposD(2,:),<span class="string">'b'</span>,<span class="string">'LineWidth'</span>,1);
plot(y_newposD(1,:),y_newposD(2,:),<span class="string">'m'</span>,<span class="string">'LineWidth'</span>,1);
hold <span class="string">off</span>
title(<span class="string">'XY Position - Multirate (No input correlation)'</span>)
legend(<span class="string">'Measured'</span>,<span class="string">'Filtered'</span>,<span class="string">'True'</span>)
xlabel(<span class="string">'Position [m]'</span>)
ylabel(<span class="string">'Position [m]'</span>)
grid <span class="string">on</span>
</pre><img vspace="5" hspace="5" src="kalman_05.png" alt=""> <img vspace="5" hspace="5" src="kalman_06.png" alt=""> <img vspace="5" hspace="5" src="kalman_07.png" alt=""> <img vspace="5" hspace="5" src="kalman_08.png" alt=""> <h2>Running Computation of the Multirate Kalman filter (Using previous GPS input when no new sample is present):<a name="14"></a></h2><pre class="codeinput"><span class="comment">% As not all of the measurements are sampled at the same time (some are</span>
<span class="comment">% slower, as the GPS for instance) - the samples where no GPS reading is</span>
<span class="comment">% available will have to increase the level of the noise. Below is a list</span>
<span class="comment">% of the sampling speeds of the sensors mounted on the ship:</span>
<span class="comment">% GPS = 1Hz;</span>
<span class="comment">% IMU = 20Hz;</span>
<span class="comment">% This calls for attention to the GPS measurements, as these are not</span>
<span class="comment">% sampled as often as the IMU! When this is done, the computation of the</span>
<span class="comment">% Kalman filter becomes:</span>

<span class="comment">% Resetting the parameters:</span>
YK = zeros(9,N);
XK = zeros(9,N);
YpredK = zeros(9,N);
XpredK = zeros(9,N);
RpredK = zeros(9,9,N);
BK = zeros(9,9,N);
YupdateK = zeros(9,N);
RupdateK = zeros(9,9,N);
k_newposK = zeros(2,N);
y_newposK = zeros(2,N);
x_newposK = zeros(2,N);
k_rotK = zeros(2,2,N);
y_rotK = zeros(2,2,N);
x_rotK = zeros(2,2,N);

sK = 1; <span class="comment">% Sample counter - used to only include the 10th GPS sample.</span>

<span class="keyword">for</span> n = 2:N;
      <span class="comment">% Wn(:,n) = randn(9,1).*SqM';</span>
     Qz(:,:,n) = cov(Z(:,n-1)*Z(:,n)');
     Qw(:,:,n) = diag([varXpos varXvel varXacc varYpos varYvel varYacc varWpos varWvel varWacc]);
       YK(:,n) = Hn*YK(:,n-1)+Z(:,n);
       XK(:,n) = An*YK(:,n)+Wn(:,n);
   YpredK(:,n) = Hn*YupdateK(:,n-1);
   XpredK(:,n) = An*YpredK(:,n);
 RpredK(:,:,n) = Hn*RupdateK(:,:,n-1)*Hn'+Qz(:,:,n);
     BK(:,:,n) = (RpredK(:,:,n)*An')/(An*RpredK(:,:,n)*An'+Qw(:,:,n));
             <span class="keyword">if</span> sK == GPS_freq; <span class="comment">% GPS_freq is the slow frequency of the GPS</span>
                   BK(1,:,n) = BK(1,:,n);
                   BK(4,:,n) = BK(4,:,n);
                          sK = 0;
             <span class="keyword">else</span>
                   BK(1,:,n) = BK(1,:,n-1);
                   BK(4,:,n) = BK(4,:,n-1);
             <span class="keyword">end</span>
 YupdateK(:,n) = YpredK(:,n)+BK(:,:,n)*(XK(:,n)-XpredK(:,n));
RupdateK(:,:,n) = (eye(9)-BK(:,:,n)*An)*RpredK(:,:,n);
            sK = sK + 1
<span class="comment">% Below - rotation udpate, so the route can be plotted:</span>
  k_rotK(:,:,n) = [cos(YupdateK(7,n-1)) -sin(YupdateK(7,n-1));sin(YupdateK(7,n-1)) cos(YupdateK(7,n-1))];
 k_newposK(:,n) = k_newposK(:,n-1) + k_rotK(:,:,n)*[YupdateK(2,n-1);YupdateK(5,n-1)].*ts; <span class="comment">% k_newposD(:,n-1)</span>
  y_rotK(:,:,n) = [cos(YK(7,n-1)) -sin(YK(7,n-1));sin(YK(7,n-1)) cos(YK(7,n-1))];
 y_newposK(:,n) = y_newposK(:,n-1) + y_rotK(:,:,n)*[YK(2,n-1);YK(5,n-1)].*ts;
  x_rotK(:,:,n) = [cos(XK(7,n-1)) -sin(XK(7,n-1));sin(XK(7,n-1)) cos(XK(7,n-1))];
 x_newposK(:,n) = y_newposK(:,n-1) + x_rotK(:,:,n)*[XK(2,n-1);XK(5,n-1)].*ts;
<span class="keyword">end</span>
</pre><pre class="codeoutput">
sK =

     2


sK =

     3


sK =

     4


sK =

     5


sK =

     6


sK =

     7


sK =

     8


sK =

     9


sK =

    10


sK =

    11


sK =

    12


sK =

    13


sK =

    14


sK =

    15


sK =

    16


sK =

    17


sK =

    18


sK =

    19


sK =

    20


sK =

     1


sK =

     2


sK =

     3


sK =

     4


sK =

     5


sK =

     6


sK =

     7


sK =

     8


sK =

     9


sK =

    10


sK =

    11


sK =

    12


sK =

    13


sK =

    14


sK =

    15


sK =

    16


sK =

    17


sK =

    18


sK =

    19


sK =

    20


sK =

     1


sK =

     2


sK =

     3


sK =

     4


sK =

     5


sK =

     6


sK =

     7


sK =

     8


sK =

     9


sK =

    10


sK =

    11


sK =

    12


sK =

    13


sK =

    14


sK =

    15


sK =

    16


sK =

    17


sK =

    18


sK =

    19


sK =

    20


sK =

     1


sK =

     2


sK =

     3


sK =

     4


sK =

     5


sK =

     6


sK =

     7


sK =

     8


sK =

     9


sK =

    10


sK =

    11


sK =

    12


sK =

    13


sK =

    14


sK =

    15


sK =

    16


sK =

    17


sK =

    18


sK =

    19


sK =

    20


sK =

     1


sK =

     2


sK =

     3


sK =

     4


sK =

     5


sK =

     6


sK =

     7


sK =

     8


sK =

     9


sK =

    10


sK =

    11


sK =

    12


sK =

    13


sK =

    14


sK =

    15


sK =

    16


sK =

    17


sK =

    18


sK =

    19


sK =

    20


sK =

     1


sK =

     2


sK =

     3


sK =

     4


sK =

     5


sK =

     6


sK =

     7


sK =

     8


sK =

     9


sK =

    10


sK =

    11


sK =

    12


sK =

    13


sK =

    14


sK =

    15


sK =

    16


sK =

    17


sK =

    18


sK =

    19


sK =

    20


sK =

     1


sK =

     2


sK =

     3


sK =

     4


sK =

     5


sK =

     6


sK =

     7


sK =

     8


sK =

     9


sK =

    10


sK =

    11


sK =

    12


sK =

    13


sK =

    14


sK =

    15


sK =

    16


sK =

    17


sK =

    18


sK =

    19


sK =

    20


sK =

     1


sK =

     2


sK =

     3


sK =

     4


sK =

     5


sK =

     6


sK =

     7


sK =

     8


sK =

     9


sK =

    10


sK =

    11


sK =

    12


sK =

    13


sK =

    14


sK =

    15


sK =

    16


sK =

    17


sK =

    18


sK =

    19


sK =

    20


sK =

     1


sK =

     2


sK =

     3


sK =

     4


sK =

     5


sK =

     6


sK =

     7


sK =

     8


sK =

     9


sK =

    10


sK =

    11


sK =

    12


sK =

    13


sK =

    14


sK =

    15


sK =

    16


sK =

    17


sK =

    18


sK =

    19


sK =

    20


sK =

     1


sK =

     2


sK =

     3


sK =

     4


sK =

     5


sK =

     6


sK =

     7


sK =

     8


sK =

     9


sK =

    10


sK =

    11


sK =

    12


sK =

    13


sK =

    14


sK =

    15


sK =

    16


sK =

    17


sK =

    18


sK =

    19


sK =

    20


sK =

     1


sK =

     2


sK =

     3


sK =

     4


sK =

     5


sK =

     6


sK =

     7


sK =

     8


sK =

     9


sK =

    10


sK =

    11


sK =

    12


sK =

    13


sK =

    14


sK =

    15


sK =

    16


sK =

    17


sK =

    18


sK =

    19


sK =

    20


sK =

     1


sK =

     2


sK =

     3


sK =

     4


sK =

     5


sK =

     6


sK =

     7


sK =

     8


sK =

     9


sK =

    10


sK =

    11


sK =

    12


sK =

    13


sK =

    14


sK =

    15


sK =

    16


sK =

    17


sK =

    18


sK =

    19


sK =

    20


sK =

     1


sK =

     2


sK =

     3


sK =

     4


sK =

     5


sK =

     6


sK =

     7


sK =

     8


sK =

     9


sK =

    10


sK =

    11


sK =

    12


sK =

    13


sK =

    14


sK =

    15


sK =

    16


sK =

    17


sK =

    18


sK =

    19


sK =

    20


sK =

     1


sK =

     2


sK =

     3


sK =

     4


sK =

     5


sK =

     6


sK =

     7


sK =

     8


sK =

     9


sK =

    10


sK =

    11


sK =

    12


sK =

    13


sK =

    14


sK =

    15


sK =

    16


sK =

    17


sK =

    18


sK =

    19


sK =

    20


sK =

     1


sK =

     2


sK =

     3


sK =

     4


sK =

     5


sK =

     6


sK =

     7


sK =

     8


sK =

     9


sK =

    10


sK =

    11


sK =

    12


sK =

    13


sK =

    14


sK =

    15


sK =

    16


sK =

    17


sK =

    18


sK =

    19


sK =

    20


sK =

     1


sK =

     2


sK =

     3


sK =

     4


sK =

     5


sK =

     6


sK =

     7


sK =

     8


sK =

     9


sK =

    10


sK =

    11


sK =

    12


sK =

    13


sK =

    14


sK =

    15


sK =

    16


sK =

    17


sK =

    18


sK =

    19


sK =

    20


sK =

     1


sK =

     2


sK =

     3


sK =

     4


sK =

     5


sK =

     6


sK =

     7


sK =

     8


sK =

     9


sK =

    10


sK =

    11


sK =

    12


sK =

    13


sK =

    14


sK =

    15


sK =

    16


sK =

    17


sK =

    18


sK =

    19


sK =

    20


sK =

     1


sK =

     2


sK =

     3


sK =

     4


sK =

     5


sK =

     6


sK =

     7


sK =

     8


sK =

     9


sK =

    10


sK =

    11


sK =

    12


sK =

    13


sK =

    14


sK =

    15


sK =

    16


sK =

    17


sK =

    18


sK =

    19


sK =

    20


sK =

     1


sK =

     2


sK =

     3


sK =

     4


sK =

     5


sK =

     6


sK =

     7


sK =

     8


sK =

     9


sK =

    10


sK =

    11


sK =

    12


sK =

    13


sK =

    14


sK =

    15


sK =

    16


sK =

    17


sK =

    18


sK =

    19


sK =

    20


sK =

     1


sK =

     2


sK =

     3


sK =

     4


sK =

     5


sK =

     6


sK =

     7


sK =

     8


sK =

     9


sK =

    10


sK =

    11


sK =

    12


sK =

    13


sK =

    14


sK =

    15


sK =

    16


sK =

    17


sK =

    18


sK =

    19


sK =

    20


sK =

     1


sK =

     2


sK =

     3


sK =

     4


sK =

     5


sK =

     6


sK =

     7


sK =

     8


sK =

     9


sK =

    10


sK =

    11


sK =

    12


sK =

    13


sK =

    14


sK =

    15


sK =

    16


sK =

    17


sK =

    18


sK =

    19


sK =

    20


sK =

     1


sK =

     2


sK =

     3


sK =

     4


sK =

     5


sK =

     6


sK =

     7


sK =

     8


sK =

     9


sK =

    10


sK =

    11


sK =

    12


sK =

    13


sK =

    14


sK =

    15


sK =

    16


sK =

    17


sK =

    18


sK =

    19


sK =

    20


sK =

     1


sK =

     2


sK =

     3


sK =

     4


sK =

     5


sK =

     6


sK =

     7


sK =

     8


sK =

     9


sK =

    10


sK =

    11


sK =

    12


sK =

    13


sK =

    14


sK =

    15


sK =

    16


sK =

    17


sK =

    18


sK =

    19


sK =

    20


sK =

     1


sK =

     2


sK =

     3


sK =

     4


sK =

     5


sK =

     6


sK =

     7


sK =

     8


sK =

     9


sK =

    10


sK =

    11


sK =

    12


sK =

    13


sK =

    14


sK =

    15


sK =

    16


sK =

    17


sK =

    18


sK =

    19


sK =

    20


sK =

     1


sK =

     2


sK =

     3


sK =

     4


sK =

     5


sK =

     6


sK =

     7


sK =

     8


sK =

     9


sK =

    10


sK =

    11


sK =

    12


sK =

    13


sK =

    14


sK =

    15


sK =

    16


sK =

    17


sK =

    18


sK =

    19


sK =

    20


sK =

     1


sK =

     2


sK =

     3


sK =

     4


sK =

     5


sK =

     6


sK =

     7


sK =

     8


sK =

     9


sK =

    10


sK =

    11


sK =

    12


sK =

    13


sK =

    14


sK =

    15


sK =

    16


sK =

    17


sK =

    18


sK =

    19


sK =

    20


sK =

     1


sK =

     2


sK =

     3


sK =

     4


sK =

     5


sK =

     6


sK =

     7


sK =

     8


sK =

     9


sK =

    10


sK =

    11


sK =

    12


sK =

    13


sK =

    14


sK =

    15


sK =

    16


sK =

    17


sK =

    18


sK =

    19


sK =

    20


sK =

     1


sK =

     2


sK =

     3


sK =

     4


sK =

     5


sK =

     6


sK =

     7


sK =

     8


sK =

     9


sK =

    10


sK =

    11


sK =

    12


sK =

    13


sK =

    14


sK =

    15


sK =

    16


sK =

    17


sK =

    18


sK =

    19


sK =

    20


sK =

     1


sK =

     2


sK =

     3


sK =

     4


sK =

     5


sK =

     6


sK =

     7


sK =

     8


sK =

     9


sK =

    10


sK =

    11


sK =

    12


sK =

    13


sK =

    14


sK =

    15


sK =

    16


sK =

    17


sK =

    18


sK =

    19


sK =

    20


sK =

     1


sK =

     2


sK =

     3


sK =

     4


sK =

     5


sK =

     6


sK =

     7


sK =

     8


sK =

     9


sK =

    10


sK =

    11


sK =

    12


sK =

    13


sK =

    14


sK =

    15


sK =

    16


sK =

    17


sK =

    18


sK =

    19


sK =

    20


sK =

     1


sK =

     2


sK =

     3


sK =

     4


sK =

     5


sK =

     6


sK =

     7


sK =

     8


sK =

     9


sK =

    10


sK =

    11


sK =

    12


sK =

    13


sK =

    14


sK =

    15


sK =

    16


sK =

    17


sK =

    18


sK =

    19


sK =

    20


sK =

     1


sK =

     2


sK =

     3


sK =

     4


sK =

     5


sK =

     6


sK =

     7


sK =

     8


sK =

     9


sK =

    10


sK =

    11


sK =

    12


sK =

    13


sK =

    14


sK =

    15


sK =

    16


sK =

    17


sK =

    18


sK =

    19


sK =

    20


sK =

     1


sK =

     2


sK =

     3


sK =

     4


sK =

     5


sK =

     6


sK =

     7


sK =

     8


sK =

     9


sK =

    10


sK =

    11


sK =

    12


sK =

    13


sK =

    14


sK =

    15


sK =

    16


sK =

    17


sK =

    18


sK =

    19


sK =

    20


sK =

     1


sK =

     2


sK =

     3


sK =

     4


sK =

     5


sK =

     6


sK =

     7


sK =

     8


sK =

     9


sK =

    10


sK =

    11


sK =

    12


sK =

    13


sK =

    14


sK =

    15


sK =

    16


sK =

    17


sK =

    18


sK =

    19


sK =

    20


sK =

     1


sK =

     2


sK =

     3


sK =

     4


sK =

     5


sK =

     6


sK =

     7


sK =

     8


sK =

     9


sK =

    10


sK =

    11


sK =

    12


sK =

    13


sK =

    14


sK =

    15


sK =

    16


sK =

    17


sK =

    18


sK =

    19


sK =

    20


sK =

     1


sK =

     2


sK =

     3


sK =

     4


sK =

     5


sK =

     6


sK =

     7


sK =

     8


sK =

     9


sK =

    10


sK =

    11


sK =

    12


sK =

    13


sK =

    14


sK =

    15


sK =

    16


sK =

    17


sK =

    18


sK =

    19


sK =

    20


sK =

     1


sK =

     2


sK =

     3


sK =

     4


sK =

     5


sK =

     6


sK =

     7


sK =

     8


sK =

     9


sK =

    10


sK =

    11


sK =

    12


sK =

    13


sK =

    14


sK =

    15


sK =

    16


sK =

    17


sK =

    18


sK =

    19


sK =

    20


sK =

     1


sK =

     2


sK =

     3


sK =

     4


sK =

     5


sK =

     6


sK =

     7


sK =

     8


sK =

     9


sK =

    10


sK =

    11


sK =

    12


sK =

    13


sK =

    14


sK =

    15


sK =

    16


sK =

    17


sK =

    18


sK =

    19


sK =

    20


sK =

     1


sK =

     2


sK =

     3


sK =

     4


sK =

     5


sK =

     6


sK =

     7


sK =

     8


sK =

     9


sK =

    10


sK =

    11


sK =

    12


sK =

    13


sK =

    14


sK =

    15


sK =

    16


sK =

    17


sK =

    18


sK =

    19


sK =

    20


sK =

     1


sK =

     2


sK =

     3


sK =

     4


sK =

     5


sK =

     6


sK =

     7


sK =

     8


sK =

     9


sK =

    10


sK =

    11


sK =

    12


sK =

    13


sK =

    14


sK =

    15


sK =

    16


sK =

    17


sK =

    18


sK =

    19


sK =

    20


sK =

     1


sK =

     2


sK =

     3


sK =

     4


sK =

     5


sK =

     6


sK =

     7


sK =

     8


sK =

     9


sK =

    10


sK =

    11


sK =

    12


sK =

    13


sK =

    14


sK =

    15


sK =

    16


sK =

    17


sK =

    18


sK =

    19


sK =

    20


sK =

     1


sK =

     2


sK =

     3


sK =

     4


sK =

     5


sK =

     6


sK =

     7


sK =

     8


sK =

     9


sK =

    10


sK =

    11


sK =

    12


sK =

    13


sK =

    14


sK =

    15


sK =

    16


sK =

    17


sK =

    18


sK =

    19


sK =

    20


sK =

     1


sK =

     2


sK =

     3


sK =

     4


sK =

     5


sK =

     6


sK =

     7


sK =

     8


sK =

     9


sK =

    10


sK =

    11


sK =

    12


sK =

    13


sK =

    14


sK =

    15


sK =

    16


sK =

    17


sK =

    18


sK =

    19


sK =

    20


sK =

     1


sK =

     2


sK =

     3


sK =

     4


sK =

     5


sK =

     6


sK =

     7


sK =

     8


sK =

     9


sK =

    10


sK =

    11


sK =

    12


sK =

    13


sK =

    14


sK =

    15


sK =

    16


sK =

    17


sK =

    18


sK =

    19


sK =

    20


sK =

     1


sK =

     2


sK =

     3


sK =

     4


sK =

     5


sK =

     6


sK =

     7


sK =

     8


sK =

     9


sK =

    10


sK =

    11


sK =

    12


sK =

    13


sK =

    14


sK =

    15


sK =

    16


sK =

    17


sK =

    18


sK =

    19


sK =

    20


sK =

     1


sK =

     2


sK =

     3


sK =

     4


sK =

     5


sK =

     6


sK =

     7


sK =

     8


sK =

     9


sK =

    10


sK =

    11


sK =

    12


sK =

    13


sK =

    14


sK =

    15


sK =

    16


sK =

    17


sK =

    18


sK =

    19


sK =

    20


sK =

     1


sK =

     2


sK =

     3


sK =

     4


sK =

     5


sK =

     6


sK =

     7


sK =

     8


sK =

     9


sK =

    10


sK =

    11


sK =

    12


sK =

    13


sK =

    14


sK =

    15


sK =

    16


sK =

    17


sK =

    18


sK =

    19


sK =

    20


sK =

     1


sK =

     2


sK =

     3


sK =

     4


sK =

     5


sK =

     6


sK =

     7


sK =

     8


sK =

     9


sK =

    10


sK =

    11


sK =

    12


sK =

    13


sK =

    14


sK =

    15


sK =

    16


sK =

    17


sK =

    18


sK =

    19


sK =

    20


sK =

     1


sK =

     2


sK =

     3


sK =

     4


sK =

     5


sK =

     6


sK =

     7


sK =

     8


sK =

     9


sK =

    10


sK =

    11


sK =

    12


sK =

    13


sK =

    14


sK =

    15


sK =

    16


sK =

    17


sK =

    18


sK =

    19


sK =

    20


sK =

     1


sK =

     2


sK =

     3


sK =

     4


sK =

     5


sK =

     6


sK =

     7


sK =

     8


sK =

     9


sK =

    10


sK =

    11


sK =

    12


sK =

    13


sK =

    14


sK =

    15


sK =

    16


sK =

    17


sK =

    18


sK =

    19


sK =

    20

</pre><h2>Output definintions - Multirate (Only changing at the new update steps!).<a name="15"></a></h2><pre class="codeinput">Y_kal_pos_XK = YupdateK(1,:)'; <span class="comment">% Updated Y - x position</span>
Y_kal_vel_XK = YupdateK(2,:)';
Y_kal_acc_XK = YupdateK(3,:)';

Y_kal_pos_YK = YupdateK(4,:)'; <span class="comment">% Updated Y - y position</span>
Y_kal_vel_YK = YupdateK(5,:)';
Y_kal_acc_YK = YupdateK(6,:)';

Y_kal_pos_WK = YupdateK(7,:)'; <span class="comment">% Updated Y - angle</span>
Y_kal_vel_WK = YupdateK(8,:)';
Y_kal_acc_WK = YupdateK(9,:)';

<span class="comment">% Measured:</span>
X_pos_XK = XK(1,:)'; <span class="comment">% Observation X - x position</span>
X_vel_XK = XK(2,:)';
X_acc_XK = XK(3,:)';

X_pos_YK = XK(4,:)'; <span class="comment">% Observation X - y position</span>
X_vel_YK = XK(5,:)';
X_acc_YK = XK(6,:)';

X_pos_WK = XK(7,:)'; <span class="comment">% Observation X - angle</span>
X_vel_WK = XK(8,:)';
X_acc_WK = XK(9,:)';

<span class="comment">% Actual:</span>
Y_pos_XK = YK(1,:)'; <span class="comment">% True Y - x position</span>
Y_vel_XK = YK(2,:)';
Y_acc_XK = YK(3,:)';

Y_pos_YK = YK(4,:)'; <span class="comment">% True Y - x position</span>
Y_vel_YK = YK(5,:)';
Y_acc_YK = YK(6,:)';

Y_pos_WK = YK(7,:)'; <span class="comment">% True Y - x position</span>
Y_vel_WK = YK(8,:)';
Y_acc_WK = YK(9,:)';
</pre><h2>Plot - Multirate Sampling (Using same samplings input as last time).<a name="16"></a></h2><pre class="codeinput">h9 = figure(9);
subplot(3,1,1)
hold <span class="string">on</span>
plot(X_pos_XK,<span class="string">'g+'</span>,<span class="string">'MarkerSize'</span>,2);
plot(Y_kal_pos_XK,<span class="string">'b'</span>,<span class="string">'LineWidth'</span>,1);
plot(Y_pos_XK,<span class="string">'m'</span>,<span class="string">'LineWidth'</span>,1);
hold <span class="string">off</span>
title(<span class="string">'X-Position Estimation - Multirate (no input change)'</span>)
legend(<span class="string">'Measured'</span>,<span class="string">'Filtered'</span>,<span class="string">'True'</span>)
xlabel(<span class="string">'Sample [n]'</span>) ;ylabel(<span class="string">'Position [m]'</span>);
grid <span class="string">on</span>

subplot(3,1,2)
hold <span class="string">on</span>
plot(X_pos_YK,<span class="string">'g+'</span>,<span class="string">'MarkerSize'</span>,2);
plot(Y_kal_pos_YK,<span class="string">'b'</span>,<span class="string">'LineWidth'</span>,1);
plot(Y_pos_YK,<span class="string">'m'</span>,<span class="string">'LineWidth'</span>,1);
hold <span class="string">off</span>
title(<span class="string">'Y-Position Estimation - Multirate (no input change)'</span>)
legend(<span class="string">'Measured'</span>,<span class="string">'Filtered'</span>,<span class="string">'True'</span>)
xlabel(<span class="string">'Sample [n]'</span>) ;ylabel(<span class="string">'Position [m]'</span>);
grid <span class="string">on</span>

subplot(3,1,3)
hold <span class="string">on</span>
plot(X_pos_WK,<span class="string">'g+'</span>,<span class="string">'MarkerSize'</span>,2);
plot(Y_kal_pos_WK,<span class="string">'b'</span>,<span class="string">'LineWidth'</span>,1);
plot(Y_pos_WK,<span class="string">'m'</span>,<span class="string">'LineWidth'</span>,1);
hold <span class="string">off</span>
title(<span class="string">'Angle Estimation - Multirate (no input change)'</span>)
legend(<span class="string">'Measured'</span>,<span class="string">'Filtered'</span>,<span class="string">'True'</span>)
xlabel(<span class="string">'Sample [n]'</span>) ;ylabel(<span class="string">'Angle [rad]'</span>);
grid <span class="string">on</span>

<span class="comment">% Plot of velocity (x,y,w)</span>
h10 = figure(10);
subplot(3,1,1)
hold <span class="string">on</span>
plot(X_vel_XK,<span class="string">'g+'</span>,<span class="string">'MarkerSize'</span>,2);
plot(Y_kal_vel_XK,<span class="string">'b'</span>,<span class="string">'LineWidth'</span>,1);
plot(Y_vel_XK,<span class="string">'m'</span>,<span class="string">'LineWidth'</span>,1);
hold <span class="string">off</span>
title(<span class="string">'X-Velocity Estimation - Multirate (no input change)'</span>)
legend(<span class="string">'Measured'</span>,<span class="string">'Filtered'</span>,<span class="string">'True'</span>)
xlabel(<span class="string">'Sample [n]'</span>) ;ylabel(<span class="string">'Velocity [m/s]'</span>);
grid <span class="string">on</span>

subplot(3,1,2)
hold <span class="string">on</span>
plot(X_vel_YK,<span class="string">'g+'</span>,<span class="string">'MarkerSize'</span>,2);
plot(Y_kal_vel_YK,<span class="string">'b'</span>,<span class="string">'LineWidth'</span>,1);
plot(Y_vel_YK,<span class="string">'m'</span>,<span class="string">'LineWidth'</span>,1);
hold <span class="string">off</span>
title(<span class="string">'Y-Velocity Estimation - Multirate (no input change)'</span>)
legend(<span class="string">'Measured'</span>,<span class="string">'Filtered'</span>,<span class="string">'True'</span>)
xlabel(<span class="string">'Sample [n]'</span>) ;ylabel(<span class="string">'Velocity [m/s]'</span>);
grid <span class="string">on</span>

subplot(3,1,3)
hold <span class="string">on</span>
plot(X_vel_WK,<span class="string">'g+'</span>,<span class="string">'MarkerSize'</span>,2);
plot(Y_kal_vel_WK,<span class="string">'b'</span>,<span class="string">'LineWidth'</span>,1);
plot(Y_vel_WK,<span class="string">'m'</span>,<span class="string">'LineWidth'</span>,1);
hold <span class="string">off</span>
title(<span class="string">'Angular Velocity Estimation - Multirate (no input change)'</span>)
legend(<span class="string">'Measured'</span>,<span class="string">'Filtered'</span>,<span class="string">'True'</span>)
xlabel(<span class="string">'Sample [n]'</span>) ;ylabel(<span class="string">'Angular velocity [rad/s]'</span>);
grid <span class="string">on</span>

<span class="comment">% Plot of acceleration (x,y,w)</span>
h11 = figure(11);
subplot(3,1,1)
hold <span class="string">on</span>
plot(X_acc_XK,<span class="string">'g+'</span>,<span class="string">'MarkerSize'</span>,2);
plot(Y_kal_acc_XK,<span class="string">'b'</span>,<span class="string">'LineWidth'</span>,1);
plot(Y_acc_XK,<span class="string">'m'</span>,<span class="string">'LineWidth'</span>,1);
hold <span class="string">off</span>
title(<span class="string">'X-Acceleration Estimation - Multirate (no input change)'</span>)
legend(<span class="string">'Measured'</span>,<span class="string">'Filtered'</span>,<span class="string">'True'</span>)
xlabel(<span class="string">'Sample [n]'</span>) ;ylabel(<span class="string">'Acceleration [m/s^2]'</span>);
grid <span class="string">on</span>

subplot(3,1,2)
hold <span class="string">on</span>
plot(X_acc_YK,<span class="string">'g+'</span>,<span class="string">'MarkerSize'</span>,2);
plot(Y_kal_acc_YK,<span class="string">'b'</span>,<span class="string">'LineWidth'</span>,1);
plot(Y_acc_YK,<span class="string">'m'</span>,<span class="string">'LineWidth'</span>,1);
hold <span class="string">off</span>
title(<span class="string">'Y-Acceleration Estimation - Multirate (no input change)'</span>)
legend(<span class="string">'Measured'</span>,<span class="string">'Filtered'</span>,<span class="string">'True'</span>)
xlabel(<span class="string">'Sample [n]'</span>) ;ylabel(<span class="string">'Acceleration [m/s^2]'</span>);
grid <span class="string">on</span>

subplot(3,1,3)
hold <span class="string">on</span>
plot(X_acc_WK,<span class="string">'g+'</span>,<span class="string">'MarkerSize'</span>,2);
plot(Y_kal_acc_WK,<span class="string">'b'</span>,<span class="string">'LineWidth'</span>,1);
plot(Y_acc_WK,<span class="string">'m'</span>,<span class="string">'LineWidth'</span>,1);
hold <span class="string">off</span>
title(<span class="string">'Angular Acceleration Estimation - Multirate (no input change)'</span>)
legend(<span class="string">'Measured'</span>,<span class="string">'Filtered'</span>,<span class="string">'True'</span>)
xlabel(<span class="string">'Sample [n]'</span>) ;ylabel(<span class="string">'Angular acceleration [rad/s]'</span>);
grid <span class="string">on</span>

<span class="comment">% Plot of actual X-Y position</span>
h12 = figure(12);
hold <span class="string">on</span>
plot(x_newposK(1,:),x_newposK(2,:),<span class="string">'g+'</span>,<span class="string">'MarkerSize'</span>,2);
plot(k_newposK(1,:),k_newposK(2,:),<span class="string">'b'</span>,<span class="string">'LineWidth'</span>,1);
plot(y_newposK(1,:),y_newposK(2,:),<span class="string">'m'</span>,<span class="string">'LineWidth'</span>,1);
hold <span class="string">off</span>
title(<span class="string">'XY Position - Multirate (Input correlation)'</span>)
legend(<span class="string">'Measured'</span>,<span class="string">'Filtered'</span>,<span class="string">'True'</span>)
xlabel(<span class="string">'Position [m]'</span>)
ylabel(<span class="string">'Position [m]'</span>)
grid <span class="string">on</span>
</pre><img vspace="5" hspace="5" src="kalman_09.png" alt=""> <img vspace="5" hspace="5" src="kalman_10.png" alt=""> <img vspace="5" hspace="5" src="kalman_11.png" alt=""> <img vspace="5" hspace="5" src="kalman_12.png" alt=""> <h2>Calculation differente between Monorate and Multirate<a name="17"></a></h2><p>The difference in X-position:</p><pre class="codeinput">diffX_pos = Y(1,:)' - Y_kal_pos_X;
diffX_posD = YD(1,:)' - Y_kal_pos_XD;
diffX_posK = YK(1,:)' - Y_kal_pos_XK;

<span class="comment">% The difference in Y-position:</span>
diffY_pos = Y(4,:)' - Y_kal_pos_Y;
diffY_posD = YD(4,:)' - Y_kal_pos_YD;
diffY_posK = YK(4,:)' - Y_kal_pos_YK;

<span class="comment">% The difference in W-position:</span>
diffW_pos = Y(7,:)' - Y_kal_pos_W;
diffW_posD = YD(7,:)' - Y_kal_pos_WD;
diffW_posK = YK(7,:)' - Y_kal_pos_WK;

<span class="comment">% The difference in X-velocity:</span>
diffX_vel = Y(2,:)' - Y_kal_vel_X;
diffX_velD = YD(2,:)' - Y_kal_vel_XD;
diffX_velK = YK(2,:)' - Y_kal_vel_XK;

<span class="comment">% The difference in Y-velocity:</span>
diffY_vel = Y(5,:)' - Y_kal_vel_Y;
diffY_velD = YD(5,:)' - Y_kal_vel_YD;
diffY_velK = YK(5,:)' - Y_kal_vel_YK;

<span class="comment">% The difference in W-velocity:</span>
diffW_vel = Y(8,:)' - Y_kal_vel_W;
diffW_velD = YD(8,:)' - Y_kal_vel_WD;
diffW_velK = YK(8,:)' - Y_kal_vel_WK;

<span class="comment">% The difference in X-acceleration:</span>
diffX_acc = Y(3,:)' - Y_kal_acc_X;
diffX_accD = YD(3,:)' - Y_kal_acc_XD;
diffX_accK = YK(3,:)' - Y_kal_acc_XK;

<span class="comment">% The difference in Y-acceleration:</span>
diffY_acc = Y(6,:)' - Y_kal_acc_Y;
diffY_accD = YD(6,:)' - Y_kal_acc_YD;
diffY_accK = YK(6,:)' - Y_kal_acc_YK;

<span class="comment">% The difference in W-acceleration:</span>
diffW_acc = Y(9,:)' - Y_kal_acc_W;
diffW_accD = YD(9,:)' - Y_kal_acc_WD;
diffW_accK = YK(9,:)' - Y_kal_acc_WK;

<span class="comment">% The difference in absolute position:</span>
diff_pos = y_newpos' - k_newpos';
diff_posD = y_newposD' - k_newposD';
diff_posK = y_newposK' - k_newposK';
</pre><h2>Plot of the error between monorate and multirate:<a name="18"></a></h2><p>Position</p><pre class="codeinput">h13 = figure(13);
subplot(3,1,1) <span class="comment">% X</span>
plot(diffX_pos,<span class="string">'b'</span>); hold <span class="string">on</span>
plot(diffX_posD,<span class="string">'r'</span>);
plot(diffX_posK,<span class="string">'g'</span>); hold <span class="string">off</span>
title(<span class="string">'Difference Monorate/Multirate - X-Position'</span>)
legend(<span class="string">'Monorate'</span>,<span class="string">'Multirate'</span>,<span class="string">'Multirate NI'</span>)
grid <span class="string">on</span>
ylabel(<span class="string">'Error [m]'</span>);
subplot(3,1,2) <span class="comment">% Y</span>
plot(diffY_pos,<span class="string">'b'</span>); hold <span class="string">on</span>
plot(diffY_posD,<span class="string">'r'</span>);
plot(diffY_posK,<span class="string">'g'</span>); hold <span class="string">off</span>
title(<span class="string">'Difference Monorate/Multirate - Y-Position'</span>)
legend(<span class="string">'Monorate'</span>,<span class="string">'Multirate'</span>,<span class="string">'Multirate NI'</span>)
grid <span class="string">on</span>
ylabel(<span class="string">'Error [m]'</span>);
subplot(3,1,3) <span class="comment">% W</span>
plot(diffW_pos,<span class="string">'b'</span>); hold <span class="string">on</span>
plot(diffW_posD,<span class="string">'r'</span>);
plot(diffW_posK,<span class="string">'g'</span>); hold <span class="string">off</span>
title(<span class="string">'Difference Monorate/Multirate - W-Position'</span>)
legend(<span class="string">'Monorate'</span>,<span class="string">'Multirate'</span>,<span class="string">'Multirate NI'</span>)
grid <span class="string">on</span>
ylabel(<span class="string">'Error [m]'</span>);
xlabel(<span class="string">'Sample [n]'</span>);
hold <span class="string">off</span>
grid <span class="string">on</span>

<span class="comment">% Velocity</span>
h14 = figure(14);
subplot(3,1,1) <span class="comment">% X</span>
plot(diffX_vel,<span class="string">'b'</span>); hold <span class="string">on</span>
plot(diffX_velD,<span class="string">'r'</span>);
plot(diffX_velK,<span class="string">'g'</span>); hold <span class="string">off</span>
title(<span class="string">'Difference Monorate/Multirate - X-Velocity'</span>)
legend(<span class="string">'Monorate'</span>,<span class="string">'Multirate'</span>,<span class="string">'Multirate NI'</span>)
grid <span class="string">on</span>
ylabel(<span class="string">'Error [m/s]'</span>);
subplot(3,1,2) <span class="comment">% Y</span>
plot(diffY_vel,<span class="string">'b'</span>); hold <span class="string">on</span>
plot(diffY_velD,<span class="string">'r'</span>);
plot(diffY_velK,<span class="string">'g'</span>); hold <span class="string">off</span>
title(<span class="string">'Difference Monorate/Multirate - Y-Velocity'</span>)
legend(<span class="string">'Monorate'</span>,<span class="string">'Multirate'</span>,<span class="string">'Multirate NI'</span>)
grid <span class="string">on</span>
ylabel(<span class="string">'Error [m/s]'</span>);
subplot(3,1,3) <span class="comment">% W</span>
plot(diffW_vel,<span class="string">'b'</span>); hold <span class="string">on</span>
plot(diffW_velD,<span class="string">'r'</span>);
plot(diffW_velK,<span class="string">'g'</span>); hold <span class="string">off</span>
title(<span class="string">'Difference Monorate/Multirate - W-Velocity'</span>)
legend(<span class="string">'Monorate'</span>,<span class="string">'Multirate'</span>,<span class="string">'Multirate NI'</span>)
ylabel(<span class="string">'Error [m/s]'</span>);
xlabel(<span class="string">'Sample [n]'</span>);
hold <span class="string">off</span>
grid <span class="string">on</span>

<span class="comment">% Acceleration</span>
h15 = figure(15);
subplot(3,1,1) <span class="comment">% X</span>
plot(diffX_accD,<span class="string">'r'</span>); hold <span class="string">on</span>
plot(diffX_acc,<span class="string">'b'</span>);
plot(diffX_accK,<span class="string">'g'</span>); hold <span class="string">off</span>
title(<span class="string">'Difference Monorate/Multirate - X-Acceleration'</span>)
legend(<span class="string">'Multirate'</span>,<span class="string">'Monorate'</span>,<span class="string">'Multirate NI'</span>)
grid <span class="string">on</span>
ylabel(<span class="string">'Error [m/s^2]'</span>);
subplot(3,1,2) <span class="comment">% Y</span>
plot(diffY_accD,<span class="string">'r'</span>); hold <span class="string">on</span>
plot(diffY_acc,<span class="string">'b'</span>);
plot(diffY_accK,<span class="string">'g'</span>); hold <span class="string">off</span>
title(<span class="string">'Difference Monorate/Multirate - Y-Acceleration'</span>)
legend(<span class="string">'Multirate'</span>,<span class="string">'Monorate'</span>,<span class="string">'Multirate NI'</span>)
grid <span class="string">on</span>
ylabel(<span class="string">'Error [m/s^2]'</span>);
subplot(3,1,3) <span class="comment">% W</span>
plot(diffW_accD,<span class="string">'r'</span>); hold <span class="string">on</span>
plot(diffW_acc,<span class="string">'b'</span>);
plot(diffW_accK,<span class="string">'g'</span>); hold <span class="string">off</span>
title(<span class="string">'Difference Monorate/Multirate - W-Acceleration'</span>)
legend(<span class="string">'Multirate'</span>,<span class="string">'Monorate'</span>,<span class="string">'Multirate NI'</span>)
ylabel(<span class="string">'Error [m/s^2]'</span>);
xlabel(<span class="string">'Sample&nbsp;[n]'</span>);
hold <span class="string">off</span>
grid <span class="string">on</span>

<span class="comment">%Absolute position:</span>
h16 = figure(16);
subplot(2,1,1)
plot(diff_pos(:,1),<span class="string">'b'</span>); hold <span class="string">on</span>
plot(diff_posD(:,1),<span class="string">'r'</span>);
plot(diff_posK(:,1),<span class="string">'g'</span>); hold <span class="string">off</span>
title(<span class="string">'Error in X-Position'</span>);
legend(<span class="string">'Monorate'</span>,<span class="string">'Multirate'</span>,<span class="string">'Multirate NI'</span>)
grid <span class="string">on</span>
subplot(2,1,2)
plot(diff_pos(:,2),<span class="string">'b'</span>); hold <span class="string">on</span>
plot(diff_posD(:,2),<span class="string">'r'</span>);
plot(diff_posK(:,2),<span class="string">'g'</span>); hold <span class="string">off</span>
title(<span class="string">'Error in Y-Position'</span>);

legend(<span class="string">'Monorate'</span>,<span class="string">'Multirate'</span>,<span class="string">'Multirate NI'</span>)
grid <span class="string">on</span>
</pre><img vspace="5" hspace="5" src="kalman_13.png" alt=""> <img vspace="5" hspace="5" src="kalman_14.png" alt=""> <img vspace="5" hspace="5" src="kalman_15.png" alt=""> <img vspace="5" hspace="5" src="kalman_16.png" alt=""> <h2>Estiamting a Wind Bias:<a name="19"></a></h2><p>As Wind might push the ship out of course (constantly in the same direction) this can be considered a bias to the system. This is then to be subtracted, so the system only computes on the actual data, rather than the wind-biased data.</p><h2>Combined Kalman filter with test inputs:<a name="20"></a></h2><p>Below is a simulation of a walk around the parking lot, with the IMU and the GPS used as reference for the ship (no bias, as the ship doesn't drift when running on wheels!).</p><p class="footer"><br><a href="http://www.mathworks.com/products/matlab/">Published with MATLAB&reg; R2012b</a><br></p></div><!--
##### SOURCE BEGIN #####
%% Kalman Filter Implementation for AAUSHIP1:
% Rasmus Christensen 26/11/2012 - 12gr730 - AAUSHIP Kalaman Filter (c) 
clc; clear all; close all;
% for lunde = 1:15
%     clf(lunde)
% end
run('contsimu.m');
load inputD.mat; % Loads system input file from contsimu.m
inputD = inputD';
close all;

% To reduce the amount of noise on the measurements which are fed to the
% system, and to enhance the precision of these, the data is run through a
% Kalman filter which is then estiamtes the position, given the noisy
% inputs. The HLI interface, which computes if the waypoint is reached,
% needs the X and Y position for the vessel to verify wether the ship has
% reached the desired waypoints. These two, can be measured by several
% devices, first of, the GPS spits out the position of the vessel, as well
% as the velocity. The velocity can be converted to a Y position, using the
% inverse of the rotation matrix. Using the IMU on board the ship, we're
% able to measure the acceleration in the X and Y direction. The IMU also
% meausres the rotational acceleration around the center of the ship.
%
% Later, this can also be used to estimate the roll of the ship, to give
% the precise position of the measurement taken, using simple geometry!
%
% First of, the state vector Y is defined as:
% Y(n) = A(n) * Y(n-1) + Z(n), where W(n) is driving noise/input to the
% system. 
%
% Then the measuremen vector X can be defined as:
% X(n) = H(n) * Y(n) + W(n), where Z(n) expresses the noisy measurements. 
%
% The desired measurements can be described as (the definition of the A
% matrix):

%% Number of Samples:
ts = 0.05; % Sampling time
N = 1000; % Then it fits with the Simulink Simulation!

%% System Parameters:
m = 12; % The ships mass
I = (1/12)*m*(0.25*0.25+1.05*1.05); % The ships inertia

betaX = 0.4462;
betaY = 0.8;
betaW = 0.0784;
GPS_freq = 20;

%% System Definition:
Hn = [1 ts (ts^2)/2 0 0 0 0 0 0;... % The X position
      0 1 ts 0 0 0 0 0 0;... % The X velocity
      0 -betaX 0 0 0 0 0 0 0;... % The X acceleration is a sum of forward motion (F_forward - F_drag)
      0 0 0 1 ts (ts^2)/2 0 0 0;... % The Y Position
      0 0 0 0 1 ts 0 0 0;... % The Y Velocity
      0 0 0 0 -betaY 0 0 0 0;... % The Y acceleration is a sum of the sideways motion (F_ymotion (wind?) - F_dragY)
      0 0 0 0 0 0 1 ts (ts^2)/2;... % The angle
      0 0 0 0 0 0 0 1 ts;... % The angular velocity
      0 0 0 0 0 0 0 -betaW 0]; % The angular acceleration is a sum of the drag an induced torque!
 
An = eye(9); % An eye matrix, as all the outputs scales equally - everything is in metric units!

%% Noise Terms (Input and Measurement Noise):
% The Z(n) is the "driving noise" - as the system input is a forward force
% and a torque, these are input here as well. The "input" matrix for the
% driving noise Z(n) is then equal to: 

Bn = [0 0;...
     0 0;...
     1/m 0;... % From force to input acceleration
     0 0;...
     0 0;...
     0 0;...
     0 0;...
     0 0;...
     0 1/I]; % From torque to angular acceleration

 for ii = 1:N
    Z(:,ii) = Bn*inputD(:,ii);
end

% W is the measurement noise on the system, this can be estimated to be
% white gaussian noise, with zero mean (for most cases) and with a
% variance, that are estimated in Appendix #XX. 
varXpos = 0.979;
varXvel = 0.00262;
varXacc = 4.9451e-5; %  m/s^2 or 5.045*10^-6 G 

varYpos = 1.12;
varYvel = 0.0001;
varYacc = 4.8815e-5; % m/s^2; or 4.9801*10^-6 G

varWpos = 0.2;
varWvel = 0.0001;
varWacc = 2.3559e-5; % m/s^2 or 2.4035*10^-6 G

varYWacc = 2.4496*10^-6; % rad/s^2
SqM = sqrt([varXpos varXvel varXacc varYpos varYvel varYacc varWpos varWvel varWacc]);

 % Random number at each iteration with a given variance. 

%% Covariance Matrices: 
% As the vector Kalman filter have several system inputs, the noise added
% to the system generates a covariance matrix. These are computed below.
% The covariance of a vector is given as: 
% cov(Z_i(n),Z_j(n)) = E[(Zi-mu_i)(Zj - mu_j)]. If the process is zero
% mean, this becomes a matrix with the diagonal entires given as: 
% cov(Z(n) = E[Z(n)*Z(n)'], but as the inputs to the system, cannot be
% considered to be zero mean, the latter is not used. 
% Qz = cov(Z(n-1)*Z(n)');
% The measuremnets, are considered to be white gaussian zero mean noise,
% and this can then be considered to be a diagonal matrix with the elements
% squared, hence there is no need for the square root, as this just gives
% the variance it self. 

%% System initiation:
% The system is initialized, the parameters are: 
Wn = zeros(9,N);
Qz = zeros(9,9,N);
Qw = zeros(9,9,N);
Y = zeros(9,N);
X = zeros(9,N);
Ypred = zeros(9,N);
Xpred = zeros(9,N);
Rpred = zeros(9,9,N);
B = zeros(9,9,N);
Yupdate = zeros(9,N);
Rupdate = zeros(9,9,N);
k_newpos = zeros(2,N);
y_newpos = zeros(2,N);
x_newpos = zeros(2,N);
k_rot = zeros(2,2,N);
y_rot = zeros(2,2,N);
x_rot = zeros(2,2,N);

%% Running Computation of the Monorate Kalman filter:
for n = 2:N;
       Wn(:,n) = randn(9,1).*SqM';
     Qz(:,:,n) = cov(Z(:,n-1)*Z(:,n)');     
     Qw(:,:,n) = diag([varXpos varXvel varXacc varYpos varYvel varYacc varWpos varWvel varWacc]);
        Y(:,n) = Hn*Y(:,n-1)+Z(:,n);
        X(:,n) = An*Y(:,n)+Wn(:,n);
    Ypred(:,n) = Hn*Yupdate(:,n-1);
    Xpred(:,n) = An*Ypred(:,n);
  Rpred(:,:,n) = Hn*Rupdate(:,:,n-1)*Hn'+Qz(:,:,n);
      B(:,:,n) = (Rpred(:,:,n)*An')/(An*Rpred(:,:,n)*An'+Qw(:,:,n));
  Yupdate(:,n) = Ypred(:,n)+B(:,:,n)*(X(:,n)-Xpred(:,n));
Rupdate(:,:,n) = (eye(9)-B(:,:,n)*An)*Rpred(:,:,n);
% Below - rotation udpate, so the route can be plotted:
  k_rot(:,:,n) = [cos(Yupdate(7,n-1)) -sin(Yupdate(7,n-1));sin(Yupdate(7,n-1)) cos(Yupdate(7,n-1))];
 k_newpos(:,n) = k_newpos(:,n-1) + k_rot(:,:,n)*[Yupdate(2,n-1);Yupdate(5,n-1)].*ts; % k_newposD(:,n-1)
  y_rot(:,:,n) = [cos(Y(7,n-1)) -sin(Y(7,n-1));sin(Y(7,n-1)) cos(Y(7,n-1))];
 y_newpos(:,n) = y_newpos(:,n-1) + y_rot(:,:,n)*[Y(2,n-1);Y(5,n-1)].*ts; 
  x_rot(:,:,n) = [cos(X(7,n-1)) -sin(X(7,n-1));sin(X(7,n-1)) cos(X(7,n-1))];
 x_newpos(:,n) = y_newpos(:,n-1) + x_rot(:,:,n)*[X(2,n-1);X(5,n-1)].*ts;
end

%% Output definitions:
% Filtered:
Y_kal_pos_X = Yupdate(1,:)'; % Updated Y - x position
Y_kal_vel_X = Yupdate(2,:)';
Y_kal_acc_X = Yupdate(3,:)'; 

Y_kal_pos_Y = Yupdate(4,:)'; % Updated Y - y position
Y_kal_vel_Y = Yupdate(5,:)';
Y_kal_acc_Y = Yupdate(6,:)'; 

Y_kal_pos_W = Yupdate(7,:)'; % Updated Y - angle
Y_kal_vel_W = Yupdate(8,:)';
Y_kal_acc_W = Yupdate(9,:)'; 

% Measured:
X_pos_X = X(1,:)'; % Observation X - x position
X_vel_X = X(2,:)';
X_acc_X = X(3,:)';

X_pos_Y = X(4,:)'; % Observation X - y position
X_vel_Y = X(5,:)';
X_acc_Y = X(6,:)';

X_pos_W = X(7,:)'; % Observation X - angle
X_vel_W = X(8,:)';
X_acc_W = X(9,:)';

% Actual:
Y_pos_X = Y(1,:)'; % True Y - x position
Y_vel_X = Y(2,:)';
Y_acc_X = Y(3,:)';

Y_pos_Y = Y(4,:)'; % True Y - x position
Y_vel_Y = Y(5,:)';
Y_acc_Y = Y(6,:)';

Y_pos_W = Y(7,:)'; % True Y - x position
Y_vel_W = Y(8,:)';
Y_acc_W = Y(9,:)';

%% Plot of figures for same Monorate sampling:
% Plot of position (x,y,w)
h1 = figure(1);
subplot(3,1,1)
hold on
plot(X_pos_X,'g+','MarkerSize',2);
plot(Y_kal_pos_X,'b','LineWidth',1);
plot(Y_pos_X,'m','LineWidth',1);
hold off
title('X-Position Estimation - Monorate')
legend('Measured','Filtered','True')
xlabel('Sample [n]') ;ylabel('Position [m]');
grid on

subplot(3,1,2)
hold on
plot(X_pos_Y,'g+','MarkerSize',2);
plot(Y_kal_pos_Y,'b','LineWidth',1);
plot(Y_pos_Y,'m','LineWidth',1);
hold off
title('Y-Position Estimation - Monorate')
legend('Measured','Filtered','True')
xlabel('Sample [n]') ;ylabel('Position [m]');
grid on

subplot(3,1,3)
hold on
plot(X_pos_W,'g+','MarkerSize',2);
plot(Y_kal_pos_W,'b','LineWidth',1);
plot(Y_pos_W,'m','LineWidth',1);
hold off
title('Angle Estimation - Monorate')
legend('Measured','Filtered','True')
xlabel('Sample [n]') ;ylabel('Angle [rad]');
grid on

% Plot of velocity (x,y,w)
h2 = figure(2);
subplot(3,1,1)
hold on
plot(X_vel_X,'g+','MarkerSize',2);
plot(Y_kal_vel_X,'b','LineWidth',1);
plot(Y_vel_X,'m','LineWidth',1);
hold off
title('X-Velocity Estimation')
legend('Measured','Filtered','True')
xlabel('Sample [n]') ;ylabel('Velocity [m/s]');
grid on

subplot(3,1,2)
hold on
plot(X_vel_Y,'g+','MarkerSize',2);
plot(Y_kal_vel_Y,'b','LineWidth',1);
plot(Y_vel_Y,'m','LineWidth',1);
hold off
title('Y-Velocity Estimation')
legend('Measured','Filtered','True')
xlabel('Sample [n]') ;ylabel('Velocity [m/s]');
grid on

subplot(3,1,3)
hold on
plot(X_vel_W,'g+','MarkerSize',2);
plot(Y_kal_vel_W,'b','LineWidth',1);
plot(Y_vel_W,'m','LineWidth',1);
hold off
title('Angular Velocity Estimation')
legend('Measured','Filtered','True')
xlabel('Sample [n]') ;ylabel('Angular velocity [rad/s]');
grid on

% Plot of acceleration (x,y,w)
h3 = figure(3);
subplot(3,1,1)
hold on
plot(X_acc_X,'g+','MarkerSize',2);
plot(Y_kal_acc_X,'b','LineWidth',1);
plot(Y_acc_X,'m','LineWidth',1);
hold off
title('X-Acceleration Estimation')
legend('Measured','Filtered','True')
xlabel('Sample [n]') ;ylabel('Acceleration [m/s^2]');
grid on

subplot(3,1,2)
hold on
plot(X_acc_Y,'g+','MarkerSize',2);
plot(Y_kal_acc_Y,'b','LineWidth',1);
plot(Y_acc_Y,'m','LineWidth',1);
hold off
title('Y-Acceleration Estimation')
legend('Measured','Filtered','True')
xlabel('Sample [n]') ;ylabel('Acceleration [m/s^2]');
grid on

subplot(3,1,3)
hold on
plot(X_acc_W,'g+','MarkerSize',2);
plot(Y_kal_acc_W,'b','LineWidth',1);
plot(Y_acc_W,'m','LineWidth',1);
hold off
title('Angular Acceleration Estimation')
legend('Measured','Filtered','True')
xlabel('Sample [n]') ;ylabel('Angular acceleration [rad/s]');
grid on

% Plot of actual X-Y position
h4 = figure(4);
hold on
plot(x_newpos(1,:),x_newpos(2,:),'g+','MarkerSize',2);
plot(k_newpos(1,:),k_newpos(2,:),'b','LineWidth',1);
plot(y_newpos(1,:),y_newpos(2,:),'m','LineWidth',1);
hold off
title('XY Position - Monorate')
legend('Measured','Filtered','True')
xlabel('Position [m]')
ylabel('Position [m]')
grid on

%% Running Computation of the Multirate Kalman filter (Negating the GPS input when no new sample is present):
% As not all of the measurements are sampled at the same time (some are
% slower, as the GPS for instance) - the samples where no GPS reading is
% available will have to increase the level of the noise. Below is a list
% of the sampling speeds of the sensors mounted on the ship:
% GPS = 1Hz;
% IMU = 20Hz;
% This calls for attention to the GPS measurements, as these are not
% sampled as often as the IMU! When this is done, the computation of the
% Kalman filter becomes: 

% Resetting the parameters:
YD = zeros(9,N);
XD = zeros(9,N);
YpredD = zeros(9,N);
XpredD = zeros(9,N);
RpredD = zeros(9,9,N);
BD = zeros(9,9,N);
YupdateD = zeros(9,N);
RupdateD = zeros(9,9,N);
k_newposD = zeros(2,N);
y_newposD = zeros(2,N);
x_newposD = zeros(2,N);
k_rotD = zeros(2,2,N);
y_rotD = zeros(2,2,N);
x_rotD = zeros(2,2,N);

sC = 0; % Sample counter - used to only include the 10th GPS sample. 

for n = 2:N;
            %sC = isinteger(n/10) % Sensor Count, used to zero out unsampled system inputs. 
      % Wn(:,n) = randn(9,1).*SqM';
     Qz(:,:,n) = cov(Z(:,n-1)*Z(:,n)');     
     Qw(:,:,n) = diag([varXpos varXvel varXacc varYpos varYvel varYacc varWpos varWvel varWacc]);
       YD(:,n) = Hn*YD(:,n-1)+Z(:,n);
       XD(:,n) = An*YD(:,n)+Wn(:,n);
   YpredD(:,n) = Hn*YupdateD(:,n-1);
   XpredD(:,n) = An*YpredD(:,n);
 RpredD(:,:,n) = Hn*RupdateD(:,:,n-1)*Hn'+Qz(:,:,n);
     BD(:,:,n) = (RpredD(:,:,n)*An')/(An*RpredD(:,:,n)*An'+Qw(:,:,n));
             if sC == GPS_freq;
                   BD(:,:,n) = BD(:,:,n);
                          sC = 0;
             else                
                   BD(1,:,n) = zeros(1,9);
                   BD(4,:,n) = zeros(1,9);
             end
 YupdateD(:,n) = YpredD(:,n)+BD(:,:,n)*(XD(:,n)-XpredD(:,n));
RupdateD(:,:,n) = (eye(9)-BD(:,:,n)*An)*RpredD(:,:,n);
            sC = sC + 1;
% Below - rotation udpate, so the route can be plotted:
  k_rotD(:,:,n) = [cos(YupdateD(7,n-1)) -sin(YupdateD(7,n-1));sin(YupdateD(7,n-1)) cos(YupdateD(7,n-1))];
 k_newposD(:,n) = k_newposD(:,n-1) + k_rotD(:,:,n)*[YupdateD(2,n-1);YupdateD(5,n-1)].*ts; % k_newposD(:,n-1)
  y_rotD(:,:,n) = [cos(YD(7,n-1)) -sin(YD(7,n-1));sin(YD(7,n-1)) cos(YD(7,n-1))];
 y_newposD(:,n) = y_newposD(:,n-1) + y_rotD(:,:,n)*[YD(2,n-1);YD(5,n-1)].*ts; 
  x_rotD(:,:,n) = [cos(XD(7,n-1)) -sin(XD(7,n-1));sin(XD(7,n-1)) cos(XD(7,n-1))];
 x_newposD(:,n) = y_newposD(:,n-1) + x_rotD(:,:,n)*[XD(2,n-1);XD(5,n-1)].*ts;
end

%% Output definitions - Multirate sampling:
% Filtered:
Y_kal_pos_XD = YupdateD(1,:)'; % Updated Y - x position
Y_kal_vel_XD = YupdateD(2,:)';
Y_kal_acc_XD = YupdateD(3,:)'; 

Y_kal_pos_YD = YupdateD(4,:)'; % Updated Y - y position
Y_kal_vel_YD = YupdateD(5,:)';
Y_kal_acc_YD = YupdateD(6,:)'; 

Y_kal_pos_WD = YupdateD(7,:)'; % Updated Y - angle
Y_kal_vel_WD = YupdateD(8,:)';
Y_kal_acc_WD = YupdateD(9,:)'; 

% Measured:
X_pos_XD = XD(1,:)'; % Observation X - x position
X_vel_XD = XD(2,:)';
X_acc_XD = XD(3,:)';

X_pos_YD = XD(4,:)'; % Observation X - y position
X_vel_YD = XD(5,:)';
X_acc_YD = XD(6,:)';

X_pos_WD = XD(7,:)'; % Observation X - angle
X_vel_WD = XD(8,:)';
X_acc_WD = XD(9,:)';

% Actual:
Y_pos_XD = YD(1,:)'; % True Y - x position
Y_vel_XD = YD(2,:)';
Y_acc_XD = YD(3,:)';

Y_pos_YD = YD(4,:)'; % True Y - x position
Y_vel_YD = YD(5,:)';
Y_acc_YD = YD(6,:)';

Y_pos_WD = YD(7,:)'; % True Y - x position
Y_vel_WD = YD(8,:)';
Y_acc_WD = YD(9,:)';

%% Plot - Multirate Sampling (x,y,w)
h5 = figure(5);
subplot(3,1,1)
hold on
plot(X_pos_XD,'g+','MarkerSize',2);
plot(Y_kal_pos_XD,'b','LineWidth',1);
plot(Y_pos_XD,'m','LineWidth',1);
hold off
title('X-Position Estimation - Multirate')
legend('Measured','Filtered','True')
xlabel('Sample [n]') ;ylabel('Position [m]');
grid on

subplot(3,1,2)
hold on
plot(X_pos_YD,'g+','MarkerSize',2);
plot(Y_kal_pos_YD,'b','LineWidth',1);
plot(Y_pos_YD,'m','LineWidth',1);
hold off
title('Y-Position Estimation - Multirate')
legend('Measured','Filtered','True')
xlabel('Sample [n]') ;ylabel('Position [m]');
grid on

subplot(3,1,3)
hold on
plot(X_pos_WD,'g+','MarkerSize',2);
plot(Y_kal_pos_WD,'b','LineWidth',1);
plot(Y_pos_WD,'m','LineWidth',1);
hold off
title('Angle Estimation - Multirate')
legend('Measured','Filtered','True')
xlabel('Sample [n]') ;ylabel('Angle [rad]');
grid on

% Plot of velocity (x,y,w)
h6 = figure(6);
subplot(3,1,1)
hold on
plot(X_vel_XD,'g+','MarkerSize',2);
plot(Y_kal_vel_XD,'b','LineWidth',1);
plot(Y_vel_XD,'m','LineWidth',1);
hold off
title('X-Velocity Estimation - Multirate')
legend('Measured','Filtered','True')
xlabel('Sample [n]') ;ylabel('Velocity [m/s]');
grid on

subplot(3,1,2)
hold on
plot(X_vel_YD,'g+','MarkerSize',2);
plot(Y_kal_vel_YD,'b','LineWidth',1);
plot(Y_vel_YD,'m','LineWidth',1);
hold off
title('Y-Velocity Estimation - Multirate')
legend('Measured','Filtered','True')
xlabel('Sample [n]') ;ylabel('Velocity [m/s]');
grid on

subplot(3,1,3)
hold on
plot(X_vel_WD,'g+','MarkerSize',2);
plot(Y_kal_vel_WD,'b','LineWidth',1);
plot(Y_vel_WD,'m','LineWidth',1);
hold off
title('Angular Velocity Estimation - Multirate')
legend('Measured','Filtered','True')
xlabel('Sample [n]') ;ylabel('Angular velocity [rad/s]');
grid on

% Plot of acceleration (x,y,w)
h7 = figure(7);
subplot(3,1,1)
hold on
plot(X_acc_XD,'g+','MarkerSize',2);
plot(Y_kal_acc_XD,'b','LineWidth',1);
plot(Y_acc_XD,'m','LineWidth',1);
hold off
title('X-Acceleration Estimation - Multirate')
legend('Measured','Filtered','True')
xlabel('Sample [n]') ;ylabel('Acceleration [m/s^2]');
grid on

subplot(3,1,2)
hold on
plot(X_acc_YD,'g+','MarkerSize',2);
plot(Y_kal_acc_YD,'b','LineWidth',1);
plot(Y_acc_YD,'m','LineWidth',1);
hold off
title('Y-Acceleration Estimation - Multirate')
legend('Measured','Filtered','True')
xlabel('Sample [n]') ;ylabel('Acceleration [m/s^2]');
grid on

subplot(3,1,3)
hold on
plot(X_acc_WD,'g+','MarkerSize',2);
plot(Y_kal_acc_WD,'b','LineWidth',1);
plot(Y_acc_WD,'m','LineWidth',1);
hold off
title('Angular Acceleration Estimation - Multirate')
legend('Measured','Filtered','True')
xlabel('Sample [n]') ;ylabel('Angular acceleration [rad/s]');
grid on

% Plot of actual X-Y position
h8 = figure(8);
hold on
plot(x_newposD(1,:),x_newposD(2,:),'g+','MarkerSize',2);
plot(k_newposD(1,:),k_newposD(2,:),'b','LineWidth',1);
plot(y_newposD(1,:),y_newposD(2,:),'m','LineWidth',1);
hold off
title('XY Position - Multirate (No input correlation)')
legend('Measured','Filtered','True')
xlabel('Position [m]')
ylabel('Position [m]')
grid on

%% Running Computation of the Multirate Kalman filter (Using previous GPS input when no new sample is present):

% As not all of the measurements are sampled at the same time (some are
% slower, as the GPS for instance) - the samples where no GPS reading is
% available will have to increase the level of the noise. Below is a list
% of the sampling speeds of the sensors mounted on the ship:
% GPS = 1Hz;
% IMU = 20Hz;
% This calls for attention to the GPS measurements, as these are not
% sampled as often as the IMU! When this is done, the computation of the
% Kalman filter becomes: 

% Resetting the parameters:
YK = zeros(9,N);
XK = zeros(9,N);
YpredK = zeros(9,N);
XpredK = zeros(9,N);
RpredK = zeros(9,9,N);
BK = zeros(9,9,N);
YupdateK = zeros(9,N);
RupdateK = zeros(9,9,N);
k_newposK = zeros(2,N);
y_newposK = zeros(2,N);
x_newposK = zeros(2,N);
k_rotK = zeros(2,2,N);
y_rotK = zeros(2,2,N);
x_rotK = zeros(2,2,N);

sK = 1; % Sample counter - used to only include the 10th GPS sample. 

for n = 2:N;
      % Wn(:,n) = randn(9,1).*SqM';
     Qz(:,:,n) = cov(Z(:,n-1)*Z(:,n)');     
     Qw(:,:,n) = diag([varXpos varXvel varXacc varYpos varYvel varYacc varWpos varWvel varWacc]);
       YK(:,n) = Hn*YK(:,n-1)+Z(:,n);
       XK(:,n) = An*YK(:,n)+Wn(:,n);
   YpredK(:,n) = Hn*YupdateK(:,n-1);
   XpredK(:,n) = An*YpredK(:,n);
 RpredK(:,:,n) = Hn*RupdateK(:,:,n-1)*Hn'+Qz(:,:,n);
     BK(:,:,n) = (RpredK(:,:,n)*An')/(An*RpredK(:,:,n)*An'+Qw(:,:,n));
             if sK == GPS_freq; % GPS_freq is the slow frequency of the GPS
                   BK(1,:,n) = BK(1,:,n);
                   BK(4,:,n) = BK(4,:,n);
                          sK = 0;
             else
                   BK(1,:,n) = BK(1,:,n-1);
                   BK(4,:,n) = BK(4,:,n-1);
             end
 YupdateK(:,n) = YpredK(:,n)+BK(:,:,n)*(XK(:,n)-XpredK(:,n));
RupdateK(:,:,n) = (eye(9)-BK(:,:,n)*An)*RpredK(:,:,n);
            sK = sK + 1
% Below - rotation udpate, so the route can be plotted:
  k_rotK(:,:,n) = [cos(YupdateK(7,n-1)) -sin(YupdateK(7,n-1));sin(YupdateK(7,n-1)) cos(YupdateK(7,n-1))];
 k_newposK(:,n) = k_newposK(:,n-1) + k_rotK(:,:,n)*[YupdateK(2,n-1);YupdateK(5,n-1)].*ts; % k_newposD(:,n-1)
  y_rotK(:,:,n) = [cos(YK(7,n-1)) -sin(YK(7,n-1));sin(YK(7,n-1)) cos(YK(7,n-1))];
 y_newposK(:,n) = y_newposK(:,n-1) + y_rotK(:,:,n)*[YK(2,n-1);YK(5,n-1)].*ts; 
  x_rotK(:,:,n) = [cos(XK(7,n-1)) -sin(XK(7,n-1));sin(XK(7,n-1)) cos(XK(7,n-1))];
 x_newposK(:,n) = y_newposK(:,n-1) + x_rotK(:,:,n)*[XK(2,n-1);XK(5,n-1)].*ts;
end

%% Output definintions - Multirate (Only changing at the new update steps!).
Y_kal_pos_XK = YupdateK(1,:)'; % Updated Y - x position
Y_kal_vel_XK = YupdateK(2,:)';
Y_kal_acc_XK = YupdateK(3,:)'; 

Y_kal_pos_YK = YupdateK(4,:)'; % Updated Y - y position
Y_kal_vel_YK = YupdateK(5,:)';
Y_kal_acc_YK = YupdateK(6,:)'; 

Y_kal_pos_WK = YupdateK(7,:)'; % Updated Y - angle
Y_kal_vel_WK = YupdateK(8,:)';
Y_kal_acc_WK = YupdateK(9,:)'; 

% Measured:
X_pos_XK = XK(1,:)'; % Observation X - x position
X_vel_XK = XK(2,:)';
X_acc_XK = XK(3,:)';

X_pos_YK = XK(4,:)'; % Observation X - y position
X_vel_YK = XK(5,:)';
X_acc_YK = XK(6,:)';

X_pos_WK = XK(7,:)'; % Observation X - angle
X_vel_WK = XK(8,:)';
X_acc_WK = XK(9,:)';

% Actual:
Y_pos_XK = YK(1,:)'; % True Y - x position
Y_vel_XK = YK(2,:)';
Y_acc_XK = YK(3,:)';

Y_pos_YK = YK(4,:)'; % True Y - x position
Y_vel_YK = YK(5,:)';
Y_acc_YK = YK(6,:)';

Y_pos_WK = YK(7,:)'; % True Y - x position
Y_vel_WK = YK(8,:)';
Y_acc_WK = YK(9,:)';

%% Plot - Multirate Sampling (Using same samplings input as last time). 
h9 = figure(9);
subplot(3,1,1)
hold on
plot(X_pos_XK,'g+','MarkerSize',2);
plot(Y_kal_pos_XK,'b','LineWidth',1);
plot(Y_pos_XK,'m','LineWidth',1);
hold off
title('X-Position Estimation - Multirate (no input change)')
legend('Measured','Filtered','True')
xlabel('Sample [n]') ;ylabel('Position [m]');
grid on

subplot(3,1,2)
hold on
plot(X_pos_YK,'g+','MarkerSize',2);
plot(Y_kal_pos_YK,'b','LineWidth',1);
plot(Y_pos_YK,'m','LineWidth',1);
hold off
title('Y-Position Estimation - Multirate (no input change)')
legend('Measured','Filtered','True')
xlabel('Sample [n]') ;ylabel('Position [m]');
grid on

subplot(3,1,3)
hold on
plot(X_pos_WK,'g+','MarkerSize',2);
plot(Y_kal_pos_WK,'b','LineWidth',1);
plot(Y_pos_WK,'m','LineWidth',1);
hold off
title('Angle Estimation - Multirate (no input change)')
legend('Measured','Filtered','True')
xlabel('Sample [n]') ;ylabel('Angle [rad]');
grid on

% Plot of velocity (x,y,w)
h10 = figure(10);
subplot(3,1,1)
hold on
plot(X_vel_XK,'g+','MarkerSize',2);
plot(Y_kal_vel_XK,'b','LineWidth',1);
plot(Y_vel_XK,'m','LineWidth',1);
hold off
title('X-Velocity Estimation - Multirate (no input change)')
legend('Measured','Filtered','True')
xlabel('Sample [n]') ;ylabel('Velocity [m/s]');
grid on

subplot(3,1,2)
hold on
plot(X_vel_YK,'g+','MarkerSize',2);
plot(Y_kal_vel_YK,'b','LineWidth',1);
plot(Y_vel_YK,'m','LineWidth',1);
hold off
title('Y-Velocity Estimation - Multirate (no input change)')
legend('Measured','Filtered','True')
xlabel('Sample [n]') ;ylabel('Velocity [m/s]');
grid on

subplot(3,1,3)
hold on
plot(X_vel_WK,'g+','MarkerSize',2);
plot(Y_kal_vel_WK,'b','LineWidth',1);
plot(Y_vel_WK,'m','LineWidth',1);
hold off
title('Angular Velocity Estimation - Multirate (no input change)')
legend('Measured','Filtered','True')
xlabel('Sample [n]') ;ylabel('Angular velocity [rad/s]');
grid on

% Plot of acceleration (x,y,w)
h11 = figure(11);
subplot(3,1,1)
hold on
plot(X_acc_XK,'g+','MarkerSize',2);
plot(Y_kal_acc_XK,'b','LineWidth',1);
plot(Y_acc_XK,'m','LineWidth',1);
hold off
title('X-Acceleration Estimation - Multirate (no input change)')
legend('Measured','Filtered','True')
xlabel('Sample [n]') ;ylabel('Acceleration [m/s^2]');
grid on

subplot(3,1,2)
hold on
plot(X_acc_YK,'g+','MarkerSize',2);
plot(Y_kal_acc_YK,'b','LineWidth',1);
plot(Y_acc_YK,'m','LineWidth',1);
hold off
title('Y-Acceleration Estimation - Multirate (no input change)')
legend('Measured','Filtered','True')
xlabel('Sample [n]') ;ylabel('Acceleration [m/s^2]');
grid on

subplot(3,1,3)
hold on
plot(X_acc_WK,'g+','MarkerSize',2);
plot(Y_kal_acc_WK,'b','LineWidth',1);
plot(Y_acc_WK,'m','LineWidth',1);
hold off
title('Angular Acceleration Estimation - Multirate (no input change)')
legend('Measured','Filtered','True')
xlabel('Sample [n]') ;ylabel('Angular acceleration [rad/s]');
grid on

% Plot of actual X-Y position
h12 = figure(12);
hold on
plot(x_newposK(1,:),x_newposK(2,:),'g+','MarkerSize',2);
plot(k_newposK(1,:),k_newposK(2,:),'b','LineWidth',1);
plot(y_newposK(1,:),y_newposK(2,:),'m','LineWidth',1);
hold off
title('XY Position - Multirate (Input correlation)')
legend('Measured','Filtered','True')
xlabel('Position [m]')
ylabel('Position [m]')
grid on

%% Calculation differente between Monorate and Multirate
% The difference in X-position:
diffX_pos = Y(1,:)' - Y_kal_pos_X;
diffX_posD = YD(1,:)' - Y_kal_pos_XD;
diffX_posK = YK(1,:)' - Y_kal_pos_XK;

% The difference in Y-position:
diffY_pos = Y(4,:)' - Y_kal_pos_Y;
diffY_posD = YD(4,:)' - Y_kal_pos_YD;
diffY_posK = YK(4,:)' - Y_kal_pos_YK;

% The difference in W-position:
diffW_pos = Y(7,:)' - Y_kal_pos_W;
diffW_posD = YD(7,:)' - Y_kal_pos_WD;
diffW_posK = YK(7,:)' - Y_kal_pos_WK;

% The difference in X-velocity:
diffX_vel = Y(2,:)' - Y_kal_vel_X;
diffX_velD = YD(2,:)' - Y_kal_vel_XD;
diffX_velK = YK(2,:)' - Y_kal_vel_XK;

% The difference in Y-velocity:
diffY_vel = Y(5,:)' - Y_kal_vel_Y;
diffY_velD = YD(5,:)' - Y_kal_vel_YD;
diffY_velK = YK(5,:)' - Y_kal_vel_YK;

% The difference in W-velocity:
diffW_vel = Y(8,:)' - Y_kal_vel_W;
diffW_velD = YD(8,:)' - Y_kal_vel_WD;
diffW_velK = YK(8,:)' - Y_kal_vel_WK;

% The difference in X-acceleration:
diffX_acc = Y(3,:)' - Y_kal_acc_X;
diffX_accD = YD(3,:)' - Y_kal_acc_XD;
diffX_accK = YK(3,:)' - Y_kal_acc_XK;

% The difference in Y-acceleration:
diffY_acc = Y(6,:)' - Y_kal_acc_Y;
diffY_accD = YD(6,:)' - Y_kal_acc_YD;
diffY_accK = YK(6,:)' - Y_kal_acc_YK;

% The difference in W-acceleration:
diffW_acc = Y(9,:)' - Y_kal_acc_W;
diffW_accD = YD(9,:)' - Y_kal_acc_WD;
diffW_accK = YK(9,:)' - Y_kal_acc_WK;

% The difference in absolute position:
diff_pos = y_newpos' - k_newpos';
diff_posD = y_newposD' - k_newposD';
diff_posK = y_newposK' - k_newposK';

%% Plot of the error between monorate and multirate:
% Position
h13 = figure(13);
subplot(3,1,1) % X
plot(diffX_pos,'b'); hold on
plot(diffX_posD,'r'); 
plot(diffX_posK,'g'); hold off
title('Difference Monorate/Multirate - X-Position')
legend('Monorate','Multirate','Multirate NI')
grid on
ylabel('Error [m]');
subplot(3,1,2) % Y
plot(diffY_pos,'b'); hold on
plot(diffY_posD,'r'); 
plot(diffY_posK,'g'); hold off
title('Difference Monorate/Multirate - Y-Position')
legend('Monorate','Multirate','Multirate NI')
grid on
ylabel('Error [m]');
subplot(3,1,3) % W
plot(diffW_pos,'b'); hold on
plot(diffW_posD,'r');
plot(diffW_posK,'g'); hold off
title('Difference Monorate/Multirate - W-Position')
legend('Monorate','Multirate','Multirate NI')
grid on
ylabel('Error [m]');
xlabel('Sample [n]');
hold off
grid on

% Velocity
h14 = figure(14);
subplot(3,1,1) % X
plot(diffX_vel,'b'); hold on
plot(diffX_velD,'r'); 
plot(diffX_velK,'g'); hold off
title('Difference Monorate/Multirate - X-Velocity')
legend('Monorate','Multirate','Multirate NI')
grid on
ylabel('Error [m/s]');
subplot(3,1,2) % Y
plot(diffY_vel,'b'); hold on
plot(diffY_velD,'r'); 
plot(diffY_velK,'g'); hold off
title('Difference Monorate/Multirate - Y-Velocity')
legend('Monorate','Multirate','Multirate NI')
grid on
ylabel('Error [m/s]');
subplot(3,1,3) % W
plot(diffW_vel,'b'); hold on
plot(diffW_velD,'r'); 
plot(diffW_velK,'g'); hold off
title('Difference Monorate/Multirate - W-Velocity')
legend('Monorate','Multirate','Multirate NI')
ylabel('Error [m/s]');
xlabel('Sample [n]');
hold off
grid on

% Acceleration
h15 = figure(15);
subplot(3,1,1) % X
plot(diffX_accD,'r'); hold on
plot(diffX_acc,'b');
plot(diffX_accK,'g'); hold off
title('Difference Monorate/Multirate - X-Acceleration')
legend('Multirate','Monorate','Multirate NI')
grid on
ylabel('Error [m/s^2]');
subplot(3,1,2) % Y
plot(diffY_accD,'r'); hold on
plot(diffY_acc,'b'); 
plot(diffY_accK,'g'); hold off
title('Difference Monorate/Multirate - Y-Acceleration')
legend('Multirate','Monorate','Multirate NI')
grid on
ylabel('Error [m/s^2]');
subplot(3,1,3) % W
plot(diffW_accD,'r'); hold on
plot(diffW_acc,'b'); 
plot(diffW_accK,'g'); hold off
title('Difference Monorate/Multirate - W-Acceleration')
legend('Multirate','Monorate','Multirate NI')
ylabel('Error [m/s^2]');
xlabel('Sample [n]');
hold off
grid on

%Absolute position:
h16 = figure(16);
subplot(2,1,1)
plot(diff_pos(:,1),'b'); hold on
plot(diff_posD(:,1),'r');
plot(diff_posK(:,1),'g'); hold off
title('Error in X-Position');
legend('Monorate','Multirate','Multirate NI')
grid on
subplot(2,1,2)
plot(diff_pos(:,2),'b'); hold on
plot(diff_posD(:,2),'r');
plot(diff_posK(:,2),'g'); hold off
title('Error in Y-Position');

legend('Monorate','Multirate','Multirate NI')
grid on

%% Estiamting a Wind Bias:
% As Wind might push the ship out of course (constantly in the same
% direction) this can be considered a bias to the system. This is then to
% be subtracted, so the system only computes on the actual data, rather
% than the wind-biased data. 

%% Combined Kalman filter with test inputs:
% Below is a simulation of a walk around the parking lot, with the IMU and
% the GPS used as reference for the ship (no bias, as the ship doesn't
% drift when running on wheels!). 
##### SOURCE END #####
--></body></html>