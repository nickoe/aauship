\chapter{Control}
\label{chap:control}

\section{Overview of the control system}
This is an overview of the information flow for control in regard to the rest of the system containing, sensors, \ac{LLI} and \ac{HLI}. The System uses a two staged control system. The control system is the heart of the autonomous navigation, it is responsible for keeping the ship on its predefined course. The inputs of the whole control system are the sensor measurement data, and the output is the motor speed \ac{PWM} percentages, passed to the \ac{LLI}.

\begin{figure}[htbp]
	\centering
	\includegraphics[width=\textwidth]{img/vessel-block-overview}
	\caption{Overview of control information flow in regard to the subsystems. The blue part indicates information that is not fetched directly to the control part, it is electrically connected to the \ac{LLI} whilst being forwarded to the \ac{HLI}.}
	\label{fig:vessel-block-overview}
\end{figure}

\todo{Illustrate on figure~\vref{fig:vessel-block-overview} where RF comms is or maybe that should be on the block overview diagram without regard to contol abstraction}

\section{Navigation control}
\subsection{Calculation of Reference Heading}

\includegraphics[width=\textwidth]{img/ControlStrategyFigures/Navigation.png}

In the First Stage the required heading of the ship is calculated that keeps the course closest to the planned waypoint.

In order to efficiently and accurately navigate along the path, a set of Sub-Waypoints is calculated for each route between two Waypoints. The main control strategy of the first path is to navigate through all of these SWPs in a predefined order, one by one. (Navigation Figure) The heading of the ship is defined in NED coordinate system. The required heading is determined by the law of Cosines, based on the Position of the Ship and the Position of the next Sub-Waypoint.
\begin{center}
\includegraphics[scale = 0.4]{img/ControlStrategyFigures/Law_of_Cosines.png}
\end{center}
Problems rise and corrections are necessary, if the heading of the ship $\theta$ is $\theta < -\pi$ or $\theta < \pi$. The heading of the ship is calculated based on the Gyro sensor and the heading can have any value in the form of: $$\theta = [-{\pi} ; \pi ] \pm 2*k*\pi$$. Before invoking the control procedure, all of the heading angles must be transformed into the $[-\pi ; \pi]$ interval.
This procedure causes a possible error though.

\includegraphics[width=\textwidth]{img/ControlStrategyFigures/Headings.png}

The required heading or the heading of the ship must be transformed into a different representation, where $$|\theta_{r}-\theta| < \pi$$. To keep a consistent heading representation, first the deviation angle $$\theta = \pi_{r}-\pi$$ is calculated, than transformed to the $[-\pi;\pi]$ interval and finally, with $\delta$ we can transform $\theta_{r}$ to $$\theta_{r}(\theta) = \theta + \delta$$.
If the conditions above are met, $\theta$ and $\theta_r(\theta)$ will always yield values that result in correct controller output.

\subsection{Subwaypoint Validity}

The overall navigation can be improved, if the Target SWPs are considered “reached” in a certain distance. Optimally this distance (Validity distance) should be somewhat longer than the minimum turning radius of the ship ($R_{min}$). If it’s shorter, the ship might not be able to reach the SWP, if it’s way longer, the ship will divert from its course in turns.

Generally if the Validity distance is approaching $R_{min}$ the ship will stay close to the Waypoints, and will navigate through a geometrically broken line, but if the ship speed is too high, the overall path-accuracy might be low. At a higher speed a longer Validity distance is recommended, because it will increase the path-accuracy in the overall navigation.

\includegraphics[width=\textwidth]{img/ControlStrategyFigures/SWP_Validity.png}

The main objective of the controller is to provide a fairly robust system that is unable to enter an unstable or uncontrollable state. In order to ensure this, we have analyzed all of the possible ship states, and crated a simple but efficient method to control the ship, by guaranteeing that the input of the second stage is always appropriate, under any circumstances. We secured this condition with the proper pair of $\theta$ and $\theta_r(\theta)$, resulting in the SWP Validity checking and the conditioning of $\theta$ and $\theta_r$.

\section{State Space Model}
\subsection{Choosing the right states}

The Second Stage ensures that the ship will stay true to its required heading, therefore staying on its local path.
\todo{Why we chose a lot of states in the beginning, and then were left with just a few, talk about that}

\subsection{Linearizing the outputs}

Using Newton's second law of motion for forward  and rotational movement (F = m * A; T = I * W'), we can easily see that the inputs to our system will be F and T representing the forward force and the torque produced by the motors. It is worth mentioning that, since there are two propellers rotating in opposite directions, a torque that would induce a rotation around Z axis passing through the boat's center of mass only if the two propellers are rotating at different speeds.

These two rotational speeds N1 and N2 were initially included in the state space model as inputs to the system, as they could be controlled directly via a PWM pulse. This though proved to complicate matters because the relationship between the speeds of the propellers N1 and N2 and the force F and torque T generating accelerations is not a linear one. Because of this, our system would not be linear and would be beyond the scope of this project. 

\todo{insert formulas for [F, T] -> [n1, n2] transformation here}

In order to prevent this from happening, the state space model was updated to only calculate the force T and torque T necessary for driving and turning the ship, and this would keep our system linear. in order to transform from [T, F] to [N1, N2], another module was introduced in the system which would implement this non-linear function. 

This is a better solution anyway because if the state space model only outputs T and F, then it could be used for some other ship configurations, without modifications to the model, only to the module that translates the force and torque to N1 and N2. This, for example, can allow us to change the size of the propellers or their positions.

\subsection{Linearizing the drag forces}

The drag forces acting on the bow of the ship while it's moving through the water are influenced by the area of the hull that is below water depth in the direction of movement, the density of the water, a drag constant $ C_{D} $ , and the square of the ship's speed components $ v_{x} $ and $ v_{y} $. 

A worthy note is the fact that the drag coefficient $ C_{D} $ will have two values depending on the direction of the ship's movement. When moving forward in the x direction, the coefficient $ C_{D}x $ will be approximated for a triangular shape, which is the closest simple shape that we have values for. For lateral movement in the y direction, $ C_{D}y $is given for a square box. These approximations should not present a problem in the operation of our control system as the errors ca easily be corrected and adjusted for by a good controller.

\[ D_{x}(v_{x}) = \frac{C_{Dx}\cdot\rho_{water}\cdot A_{front}\cdot v_{x}^{2}}{2} \]
\[ D_{y}(v_{y}) = \frac{C_{Dy}\cdot\rho_{water}\cdot A_{side}\cdot  v_{y}^{2}}{2} \]

Where $ D_{x}(v_{x}) $ and $ D_{y}(v_{y})$ are the drag forces dependent on the forward and lateral speeds respectively, $ \rho_{water} $ is the density of the water, $ A_{front} $ is the frontal area of the hull and $ A_{side} $ is the lateral area. 

The drag torque that is produced by the drag force acting on the hull of the ship, as the ship rotates through the water is dependent on the square of the angular velocity $ \omega $:

\[ \tau(\omega) = \frac{C_{D} \cdot \rho_{water} \cdot d \cdot (r_{f}^{4} + r_{b}^{4}) \cdot \omega^{2}}{8} \]

Where $ \tau(\omega) $ is the torque generated by the angular speed $ \omega $, $ d  $ is the depth of the ship that is submerged in water, $ r_{f} $ and $ r_{b} $ are the radii of the ship from the center of mass towards the front and back end, respectively.

These forces are obviously non-linear and thus cannot be integrated into the linear Kalman filter or State Space Model. Because we will usually use a constant speed it is feasible to linearize these forces for that value and not have big errors. The angular drag torque can also be linearized around a mean turning speed because the radii of the corners of the paths are also constant.

Approximation of the drag forces around the points of interest $v_{l} $ and $\omega_{l}$ is done using the first order term of the Taylor expansion:

\[ y_{l}(x) = f(a) + f'(a)(x-a) \]

Where $y = f(x)$ is the function we want to linearize around a value of interest $a$. Applying this formula to our situation yields:

\[ Dx_{l}(v_{x}) = \frac{C_{D}x\cdot\rho_{water}\cdot A_{front}\cdot v_{l}^{2}}{2} + (C_{D}x\cdot\rho_{water}\cdot A_{front})\cdot (v_{x}-v_{l}) \]

\[ Dy_{l}(v_{y}) = \frac{C_{Dy}\cdot\rho_{water}\cdot A_{side}\cdot v_{l}^{2}}{2} + (C_{D}y\cdot\rho_{water}\cdot A_{side})\cdot (v_{y}-v_{l}) \]

\[ \tau_{l}(\omega) = \frac{C_{D}y \cdot \rho_{water} \cdot d \cdot (r_{f}^{4} + r_{b}^{4}) \cdot \omega_{l}^{2}}{8} + \frac{C_{D}y \cdot \rho_{water} \cdot d \cdot (r_{f}^{4} + r_{b}^{4}) \cdot \omega_{l}}{4} \cdot (\omega - \omega_{l}) \] 

\begin{figure}[htbp]
	\centering
	\includegraphics[width=\textwidth, trim=1.8cm 0cm 0cm 2cm, clip = true, angle = 90, width=\textwidth]{img/ship_sizes}
	\caption{Sketch of ship sizes as measured after the maiden voyage}
	\label{fig:ship_sizes}
\end{figure}

Given \vref{fig:ship_sizes}
 $ v_{l} = 1m/s $ ,
 $ \omega_{l} = 1 s ^{-1} $ ,
 $ C_{D}x = 0.5 $ (for a triangle) ,
 $ C_{D}y = 1 $ (for a box) ,
 $ \rho = 1000 kg/m ^{2} $,
 $ A_{front} = 0.0178 m^{2} $,
 $ A_{side} = 0.0840 m ^{2} $,
 $ d = 0.0775 m $,
 $ r_{f} = 0.6208 m $,
 $ r_{b} = 0.4642 m $,
 
the linearized formulas for the drag forces can be computed to be:

\[ Dx_{l}(v) = -4.45 + 8.9 \cdot v_{x} \]
\[ Dy_{l}(v) = -42 + 84 \cdot v_{y} \]
\[ \tau_{l}(\omega) = -1.88 + 3.77 \cdot \omega \]

From which we can identify the coefficients that correspond tot the linear relation $ y_{l}(x) = \alpha + \beta \cdot x $:\\
\begin{minipage}{0.3\linewidth}	
\[ \alpha_{x} = -4.45 \] 
\[ \beta_{x} = 8.9 \]
\end{minipage}
\begin{minipage}{0.3\linewidth}	
\[ \alpha_{y} = -42 \] 
\[ \beta_{y} = 84 \]
\end{minipage}
\begin{minipage}{0.3\linewidth}
\[ \alpha_{\omega} = -1.88 \]
\[ \beta_{\omega} = 3.77 \]
\end{minipage}
